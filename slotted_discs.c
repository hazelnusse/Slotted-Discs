#include "slotted_discs.h"

double sdcalcSpin(sd_t * p)
{
  int iter = 0;
  gsl_root_fdfsolver_set(p->fdf_s, &(p->fdf), p->q3 + (p->h)*(p->q3p));
  do
  {
    gsl_root_fdfsolver_iterate(bike->fdf_s);
    p->status = gsl_root_test_residual(
                hc_f(gsl_root_fdfsolver_root(bike->fdf_s), p), 1e-16);
  } while (p->status == GSL_CONTINUE && ++iter < 100);

  p->q3 = gsl_root_fdfsolver_root(p->fdf_s);
  return p->q3;
}

void sdFree(sd_t *p)
{
  gsl_odeiv_evolve_free(discs->e);
  gsl_odeiv_control_free(discs->c);
  gsl_odeiv_step_free(discs->s);

  gsl_root_fdfsolver_free(p->fdf_s);

}

void sdInit(sd_t * p)
{
  int i;
  // Setup Numerical simulation
  p->T = gsl_odeiv_step_rk8pd;
  p->s = gsl_odeiv_step_alloc(p->T, 5);
  p->c = gsl_odeiv_control_y_new(1e-9, 0.0);
  p->e = gsl_odeiv_evolve_alloc(5);
  (p->sys).function = sdF;
  (p->sys).jacobian = NULL;
  (p->sys).dimension = 5;
  (p->sys).params = p;
  
  // Newton-Raphson setup
  (p->fdf).f = &sdConstraint_f;
  (p->fdf).df = &sdConstraint_df;
  (p->fdf).fdf = &sdConstraint_fdf;
  (p->fdf).params = p;
  p->fdf_t = gsl_root_fdfsolver_newton;
  p->fdf_s = gsl_root_fdfsolver_alloc(p->fdf_t);

  // Setting model parameters and initial conditions
  p->t = p->x[0] = p->x[1] = p->x[2] = p->x[3] = p->x[4] = 0.0;
  p->tf = 10.0;
  p->h = 0.001;
  p->ra = p->rb = p->ma = p->mb = 1.0;
  p->m = p->ma + p->mb;
  p->l = 1.25;
  p->q3 = (M_PI / 2.0) + asin(p->ra / (p->rb + p->l));
  p->k = p->mb / p->m * p->l;
  sdSetInertia(p);

  p->g = 9.81;
  p->alpha = M_PI / 2.0;

  for (i = 0; i < 15; ++i)
    p->T_da[i] = p->T_db[i] = 0.0;

  for (i = 0; i < 222; ++i)
    p->z[i] = 0.0;

  p->T_da[15] = p->T_db[15] = 1.0;

  /* Evaluate constants */
  p->z[7] = cos(p->alpha);
  p->z[112] = p->g*p->m;
  p->z[8] = sin(p->alpha);
  p->z[146] = p->rb*p->z[7];
  p->z[152] = p->rb*p->z[8];

  sdF(0.0, p->x, p->f, p);
  sdOutputs(p);

} // sdinit()

int sdF(double t, const double *x, double *f, void *params)
{
  sd_t * p = (sd_t *) params;
  double q1 = x[0];
  double q2 = x[1];
  double u = x[5];
  double q1p, q2p, q3p, q4p, q5p, up, w1, w2, * z = p->z,
         ra = p->ra,
         rb = p->rb,
         k = p->k,
         l = p->l,
         m = p->m,
         Ix = p->Ix,
         Iy = p->Iy,
         Iz = p->Iz;

  double q3 = sdcalcSpin(p);
  
  z[4] = sin(q2);
  z[3] = cos(q2);
  z[6] = sin(q3);
  z[11] = z[3]*z[6];
  z[24] = z[7]*z[4] + z[8]*z[11];
  z[5] = cos(q3);
  z[12] = z[3]*z[5];
  z[31] = z[8]*z[12];
  z[33] = z[24]*z[31];
  z[25] = 1 - pow(z[24],2);
  z[35] = z[33]/pow(z[25],0.5);
  z[26] = pow(z[25],0.5);
  z[47] = (z[24]*z[35]+z[26]*z[31])/pow(z[26],2);
  z[49] = rb*z[47];
  z[28] = z[24]/z[26];
  z[30] = rb*z[28];
  z[37] = z[35]/pow(z[26],2);
  z[39] = rb*z[37];
  z[51] = z[24]*z[49] + z[30]*z[31] - z[39] - l*z[11];
  z[9] = z[4]*z[6];
  z[22] = z[7]*z[3] - z[8]*z[9];
  z[32] = z[22]*z[24];
  z[34] = z[32]/pow(z[25],0.5);
  z[36] = z[34]/pow(z[26],2);
  z[38] = rb*z[36];
  z[10] = z[4]*z[5];
  z[13] = 1 - pow(z[4],2);
  z[14] = pow(z[13],0.5);
  z[16] = z[4]/z[14];
  z[18] = ra*z[16];
  z[40] = z[3]*z[4];
  z[41] = z[40]/pow(z[13],0.5);
  z[44] = (z[3]*z[14]+z[4]*z[41])/pow(z[14],2);
  z[45] = ra*z[44];
  z[42] = z[41]/pow(z[14],2);
  z[43] = ra*z[42];
  z[46] = (z[22]*z[26]+z[24]*z[34])/pow(z[26],2);
  z[48] = rb*z[46];
  z[50] = z[38] + l*z[10] + z[3]*z[18] + z[4]*z[45] - z[43] - z[22]*z[30] - 
  z[24]*z[48];
  z[52] = z[51]/z[50];
  z[1] = cos(q1);
  z[15] = 1/z[14];
  z[17] = ra*z[15];
  z[2] = sin(q1);
  z[27] = 1/z[26];
  z[29] = rb*z[27];
  z[53] = z[6]*z[18] - z[7]*z[6]*z[30] - z[9]*(z[17]-z[29]);
  z[23] = z[8]*z[4] - z[7]*z[11];
  z[58] = -z[11]*z[18] - z[23]*z[30];
  z[55] = l*z[4] + z[12]*z[18] - z[7]*z[12]*z[30];
  z[19] = z[7]*z[5];
  z[57] = z[5]*z[18] - z[19]*z[30] - z[10]*(z[17]-z[29]);
  z[56] = l*z[11] - z[8]*z[12]*z[30];
  z[54] = -l*z[5] - z[8]*z[6]*z[30] - z[3]*(z[17]-z[29]);
  z[59] = z[53]*z[56] - z[54]*z[55];
  z[61] = (z[53]*z[58]-z[55]*z[57])/z[59];
  z[62] = z[4]*z[17] - z[18] - z[61]*(k+z[12]*z[17]);
  z[60] = (z[54]*z[58]-z[56]*z[57])/z[59];
  z[63] = z[11]*z[17] - z[60]*(k+z[12]*z[17]);
  z[64] = -z[11]*z[17]*z[61] - z[60]*(z[18]-z[4]*z[17]);
  z[72] = z[8]*z[10]*z[30] - l*z[9] - z[8]*z[12]*z[48];
  z[77] = z[6]*z[45] + z[9]*(z[38]-z[43]) - z[7]*z[6]*z[48] - z[11]*(z[17]-
  z[29]);
  z[79] = l*z[3] + z[12]*z[45] + z[7]*z[10]*z[30] - z[10]*z[18] - z[7]*z[12]*
  z[48];
  z[68] = z[3]*(z[38]-z[43]) + z[4]*(z[17]-z[29]) - z[8]*z[6]*z[48];
  z[81] = z[53]*z[72] + z[56]*z[77] - z[54]*z[79] - z[55]*z[68];
  z[75] = z[5]*z[45] + z[10]*(z[38]-z[43]) - z[19]*z[48] - z[12]*(z[17]-z[29]);
  z[21] = z[7]*z[9] + z[8]*z[3];
  z[70] = z[9]*z[18] - z[11]*z[45] - z[21]*z[30] - z[23]*z[48];
  z[87] = (z[81]*(z[53]*z[58]-z[55]*z[57])+z[59]*(z[55]*z[75]+z[57]*z[79]-
  z[53]*z[70]-z[58]*z[77]))/pow(z[59],2);
  z[89] = u*z[87];
  z[65] = u*z[60];
  z[66] = u*z[61];
  z[67] = l*z[6] + z[3]*z[39] - z[8]*z[5]*z[30] - z[8]*z[6]*z[49];
  z[69] = z[7]*z[12];
  z[71] = z[30]*z[69] - z[12]*z[18] - z[23]*z[49];
  z[73] = l*z[12] + z[8]*z[11]*z[30] - z[8]*z[12]*z[49];
  z[74] = z[7]*z[6];
  z[76] = z[10]*z[39] + z[30]*z[74] + z[9]*(z[17]-z[29]) - z[6]*z[18] - z[19]*
  z[49];
  z[78] = z[5]*z[18] + z[9]*z[39] - z[7]*z[5]*z[30] - z[7]*z[6]*z[49] - z[10]*(
  z[17]-z[29]);
  z[80] = z[7]*z[11]*z[30] - z[11]*z[18] - z[7]*z[12]*z[49];
  z[82] = z[53]*z[73] + z[56]*z[78] - z[54]*z[80] - z[55]*z[67];
  z[83] = (z[81]*(z[54]*z[58]-z[56]*z[57])+z[59]*(z[56]*z[75]+z[57]*z[72]-
  z[54]*z[70]-z[58]*z[68]))/pow(z[59],2);
  z[84] = (z[82]*(z[54]*z[58]-z[56]*z[57])+z[59]*(z[56]*z[76]+z[57]*z[73]-
  z[54]*z[71]-z[58]*z[67]))/pow(z[59],2);
  z[85] = u*z[83];
  z[86] = u*z[84];
  z[88] = (z[82]*(z[53]*z[58]-z[55]*z[57])+z[59]*(z[55]*z[76]+z[57]*z[80]-
  z[53]*z[71]-z[58]*z[78]))/pow(z[59],2);
  z[90] = u*z[88];
  z[93] = u*z[62];
  z[94] = u*z[63];
  z[95] = u*z[64];
  z[96] = z[3]*z[17] + z[4]*z[43] + z[87]*(k+z[12]*z[17]) + z[61]*(z[10]*
  z[17]-z[12]*z[43]) - z[45];
  z[97] = z[11]*z[17]*z[61] + z[88]*(k+z[12]*z[17]);
  z[98] = u*z[96];
  z[99] = u*z[97];
  z[100] = z[11]*z[43] + z[83]*(k+z[12]*z[17]) + z[60]*(z[10]*z[17]-z[12]*
  z[43]) - z[9]*z[17];
  z[101] = z[12]*z[17] + z[11]*z[17]*z[60] + z[84]*(k+z[12]*z[17]);
  z[102] = u*z[100];
  z[103] = u*z[101];
  z[104] = z[9]*z[17]*z[61] + z[11]*z[17]*z[87] + z[83]*(z[18]-z[4]*z[17]) - 
  z[11]*z[43]*z[61] - z[60]*(z[45]-z[3]*z[17]-z[4]*z[43]);
  z[105] = z[11]*z[17]*z[88] + z[84]*(z[18]-z[4]*z[17]) - z[12]*z[17]*z[61];
  z[106] = u*z[104];
  z[107] = u*z[105];
  z[111] = -Iz - Ix*pow(z[60],2) - Iy*pow(z[61],2) - m*(pow(z[62],2)+pow(
  z[63],2)+pow(z[64],2));

/* Quantities which were specified */
  w1 = -u*z[60];
  w2 = u*z[61];

  q1p = -(w1*sin(q3)-u*cos(q3))/cos(q2);
  q3p = w2 + tan(q2)*(w1*sin(q3)-u*cos(q3));
  q2p = z[52]*q3p;
  q4p = -z[1]*z[3]*z[17]*q3p;
  q5p = -z[2]*z[3]*z[17]*q3p;
  z[92] = -z[89]*q2p - z[90]*q3p;
  z[108] = z[66]*z[95] + z[98]*q2p + z[99]*q3p - u*z[94];
  z[109] = u*z[93] + z[65]*z[95] + z[102]*q2p + z[103]*q3p;
  z[110] = z[106]*q2p + z[107]*q3p - z[65]*z[94] - z[66]*z[93];
  z[91] = z[85]*q2p + z[86]*q3p;
  z[113] = z[112]*(z[11]*z[62]-z[4]*z[63]-z[12]*z[64]) + Iy*z[61]*z[92] + m*(
  z[62]*z[108]+z[63]*z[109]+z[64]*z[110]) - Ix*z[60]*z[91];
  z[114] = z[113]/z[111];
  up = z[114];

  /* Update derivative array prior to integration step */
  f[0] = q1p;
  f[1] = q2p;
  f[2] = q3p;
  f[3] = q4p;
  f[4] = q5p;
  f[5] = up;
  p->w1 = w1;
  p->w2 = w2;

  return GSL_SUCCESS;
} // sdF()

void sdOutputs(sd_t * p)
{
  double *z = p->z,
         q2p = p->f[1],
         q3p = p->f[2],
         q2 = p->x[1],
         q4 = p->x[3],
         q5 = p->x[4],
         u = p->x[5],
         ra = p->ra,
         rb = p->rb,
         k = p->k,
         l = p->l,
         m = p->m,
         Ix = p->Ix,
         Iy = p->Iy,
         Iz = p->Iz,
         g = p->g,
         w1 = p->w1;
  
  z[20] = z[8]*z[5];
  p->ke = 0.5*m*pow((pow(z[93],2)+pow(z[94],2)+pow(z[95],2)),0.5) + 0.5*pow(u,2)*(
  Iz+Ix*pow(z[60],2)+Iy*pow(z[61],2));
  p->pe = g*m*(z[17]+k*z[12]-z[4]*z[18]);
  z[115] = z[1]*z[5] - z[2]*z[9];
  z[116] = z[2]*z[3];
  z[117] = z[1]*z[6] + z[2]*z[10];
  z[118] = z[1]*z[9] + z[2]*z[5];
  z[119] = z[1]*z[3];
  z[120] = z[2]*z[6] - z[1]*z[10];
  z[121] = z[1]*z[19] - z[2]*z[21];
  z[122] = -z[1]*z[20] - z[2]*z[22];
  z[123] = z[1]*z[21] + z[2]*z[19];
  z[124] = z[1]*z[22] - z[2]*z[20];
  z[125] = z[7]*z[3] - z[8]*z[4]*z[6];
  z[126] = z[31]*z[125] - z[8]*z[4]*z[5]*z[24];
  z[127] = (z[25]*z[126]+z[24]*z[33]*z[125])/pow(z[25],1.5);
  z[128] = (z[24]*z[125]*(z[26]*z[31]+2*z[24]*z[35])/pow(z[25],0.5)+z[26]*(
  z[24]*z[127]+z[35]*z[125]-z[8]*z[4]*z[5]*z[26]))/pow(z[26],3);
  z[129] = z[125]*(z[26]+pow(z[24],2)/pow(z[25],0.5))/pow(z[26],2);
  z[130] = (z[26]*z[127]+2*z[24]*z[35]*z[125]/pow(z[25],0.5))/pow(z[26],3);
  z[131] = z[49]*z[125] + l*z[4]*z[6] + rb*z[24]*z[128] + rb*z[31]*z[129] - 
  rb*z[130] - z[8]*z[4]*z[5]*z[30];
  z[132] = -z[7]*z[4] - z[8]*z[3]*z[6];
  z[133] = z[22]*z[125] + z[24]*z[132];
  z[134] = (z[25]*z[133]+z[24]*z[32]*z[125])/pow(z[25],1.5);
  z[135] = (z[26]*z[134]+2*z[24]*z[34]*z[125]/pow(z[25],0.5))/pow(z[26],3);
  z[136] = z[3]*(z[14]+pow(z[4],2)/pow(z[13],0.5))/pow(z[14],2);
  z[137] = pow(z[3],2) - pow(z[4],2);
  z[138] = (z[13]*z[137]+z[3]*z[4]*z[40])/pow(z[13],1.5);
  z[139] = (z[3]*z[4]*(z[3]*z[14]+2*z[4]*z[41])/pow(z[13],0.5)-z[14]*(z[4]*
  z[14]-z[3]*z[41]-z[4]*z[138]))/pow(z[14],3);
  z[140] = (z[14]*z[138]+2*z[3]*z[4]*z[41]/pow(z[13],0.5))/pow(z[14],3);
  z[141] = (z[26]*(z[24]*z[134]+z[26]*z[132]+z[34]*z[125])+z[24]*z[125]*(
  z[22]*z[26]+2*z[24]*z[34])/pow(z[25],0.5))/pow(z[26],3);
  z[142] = rb*z[135] + z[3]*z[45] + l*z[3]*z[5] + ra*z[3]*z[136] + ra*z[4]*
  z[139] - ra*z[140] - z[4]*z[18] - z[30]*z[132] - z[48]*z[125] - rb*z[22]*
  z[129] - rb*z[24]*z[141];
  z[143] = (z[50]*z[131]-z[51]*z[142])/pow(z[50],2);
  z[144] = z[3]*z[4]/(pow(z[13],0.5)*pow(z[14],2));
  z[145] = z[24]*z[125]/(pow(z[25],0.5)*pow(z[26],2));
  z[147] = ra*z[6]*z[136] - z[146]*z[6]*z[129] - z[3]*z[6]*(z[17]-z[29]) - 
  z[9]*(ra*z[144]-rb*z[145]);
  z[148] = z[8]*z[3] + z[7]*z[4]*z[6];
  z[149] = z[4]*z[6]*z[18] - z[30]*z[148] - ra*z[11]*z[136] - rb*z[23]*z[129];
  z[150] = l*z[3] + ra*z[12]*z[136] + z[7]*z[4]*z[5]*z[30] - z[146]*z[12]*
  z[129] - z[4]*z[5]*z[18];
  z[151] = ra*z[5]*z[136] - rb*z[19]*z[129] - z[3]*z[5]*(z[17]-z[29]) - z[10]*(
  ra*z[144]-rb*z[145]);
  z[153] = z[8]*z[4]*z[5]*z[30] - l*z[4]*z[6] - z[152]*z[12]*z[129];
  z[154] = z[4]*(z[17]-z[29]) - z[152]*z[6]*z[129] - z[3]*(ra*z[144]-rb*
  z[145]);
  z[155] = z[53]*z[153] + z[56]*z[147] - z[54]*z[150] - z[55]*z[154];
  z[156] = (z[155]*(z[53]*z[58]-z[55]*z[57])+z[59]*(z[55]*z[151]+z[57]*z[150]-
  z[53]*z[149]-z[58]*z[147]))/pow(z[59],2);
  z[157] = (z[155]*(z[54]*z[58]-z[56]*z[57])+z[59]*(z[56]*z[151]+z[57]*z[153]-
  z[54]*z[149]-z[58]*z[154]))/pow(z[59],2);
  z[158] = tan(q2);
  z[159] = u*z[6]*z[157]*z[158] + (w1*z[6]-u*z[5])/pow(z[3],2) - u*z[156];
  z[160] = z[61] - z[158]*(z[5]+z[6]*z[60]);
  z[161] = z[3]*z[17] + ra*z[4]*z[144] + z[156]*(k+z[12]*z[17]) - ra*z[136] - 
  z[61]*(ra*z[12]*z[144]-z[4]*z[5]*z[17]);
  z[162] = ra*z[11]*z[144] + z[157]*(k+z[12]*z[17]) - z[4]*z[6]*z[17] - z[60]*(
  ra*z[12]*z[144]-z[4]*z[5]*z[17]);
  z[163] = z[11]*z[17]*z[156] + z[4]*z[6]*z[17]*z[61] + z[157]*(z[18]-z[4]*
  z[17]) - ra*z[11]*z[61]*z[144] - z[60]*(ra*z[136]-z[3]*z[17]-ra*z[4]*z[144]);
  z[164] = z[152]*z[10]*z[129] + z[8]*z[3]*z[5]*z[30] + z[8]*z[4]*z[5]*z[48] - 
  l*z[3]*z[6] - z[152]*z[12]*z[141];
  z[165] = ra*z[6]*z[139] + z[3]*z[6]*(z[38]-z[43]) + z[4]*z[6]*(z[17]-z[29]) - 
  z[146]*z[6]*z[141] - z[9]*(ra*z[140]-rb*z[135]) - z[11]*(ra*z[144]-rb*
  z[145]);
  z[166] = ra*z[12]*z[139] + z[146]*z[10]*z[129] + z[7]*z[3]*z[5]*z[30] + 
  z[7]*z[4]*z[5]*z[48] - l*z[4] - ra*z[10]*z[136] - z[146]*z[12]*z[141] - 
  z[3]*z[5]*z[18] - z[4]*z[5]*z[45];
  z[167] = z[3]*(z[17]-z[29]) + z[4]*(ra*z[144]-rb*z[145]) - z[152]*z[6]*
  z[141] - z[4]*(z[38]-z[43]) - z[3]*(ra*z[140]-rb*z[135]);
  z[168] = z[53]*z[164] + z[56]*z[165] + z[72]*z[147] + z[77]*z[153] - z[54]*
  z[166] - z[55]*z[167] - z[68]*z[150] - z[79]*z[154];
  z[169] = ra*z[5]*z[139] + z[3]*z[5]*(z[38]-z[43]) + z[4]*z[5]*(z[17]-z[29]) - 
  rb*z[19]*z[141] - z[10]*(ra*z[140]-rb*z[135]) - z[12]*(ra*z[144]-rb*z[145]);
  z[170] = z[7]*z[3]*z[6] - z[8]*z[4];
  z[171] = ra*z[9]*z[136] + z[3]*z[6]*z[18] + z[4]*z[6]*z[45] - z[30]*z[170] - 
  z[48]*z[148] - ra*z[11]*z[139] - rb*z[21]*z[129] - rb*z[23]*z[141];
  z[172] = (2*z[81]*z[155]*(z[53]*z[58]-z[55]*z[57])-z[59]*(z[168]*(z[53]*
  z[58]-z[55]*z[57])-z[81]*(z[55]*z[151]+z[57]*z[150]-z[53]*z[149]-z[58]*
  z[147])-z[155]*(z[55]*z[75]+z[57]*z[79]-z[53]*z[70]-z[58]*z[77])-z[59]*(
  z[53]*z[171]+z[58]*z[165]+z[70]*z[147]+z[77]*z[149]-z[55]*z[169]-z[57]*
  z[166]-z[75]*z[150]-z[79]*z[151])))/pow(z[59],3);
  z[173] = z[52]*z[159] + z[143]*q3p;
  z[174] = z[152]*z[11]*z[129] + z[8]*z[4]*z[5]*z[49] - l*z[4]*z[5] - z[152]*
  z[12]*z[128] - z[8]*z[4]*z[6]*z[30];
  z[175] = ra*z[5]*z[136] + rb*z[9]*z[130] + z[3]*z[6]*z[39] - z[146]*z[5]*
  z[129] - z[146]*z[6]*z[128] - z[3]*z[5]*(z[17]-z[29]) - z[10]*(ra*z[144]-rb*
  z[145]);
  z[176] = z[146]*z[11]*z[129] + z[4]*z[6]*z[18] + z[7]*z[4]*z[5]*z[49] - ra*
  z[11]*z[136] - z[146]*z[12]*z[128] - z[7]*z[4]*z[6]*z[30];
  z[177] = rb*z[3]*z[130] - z[4]*z[39] - z[152]*z[5]*z[129] - z[152]*z[6]*
  z[128];
  z[178] = z[53]*z[174] + z[56]*z[175] + z[73]*z[147] + z[78]*z[153] - z[54]*
  z[176] - z[55]*z[177] - z[67]*z[150] - z[80]*z[154];
  z[179] = rb*z[10]*z[130] + rb*z[74]*z[129] + z[3]*z[5]*z[39] + z[3]*z[6]*(
  z[17]-z[29]) + z[9]*(ra*z[144]-rb*z[145]) - ra*z[6]*z[136] - rb*z[19]*
  z[128];
  z[180] = rb*z[69]*z[129] + z[4]*z[5]*z[18] - z[49]*z[148] - ra*z[12]*z[136] - 
  rb*z[23]*z[128] - z[7]*z[4]*z[5]*z[30];
  z[181] = (2*z[82]*z[155]*(z[53]*z[58]-z[55]*z[57])-z[59]*(z[178]*(z[53]*
  z[58]-z[55]*z[57])-z[82]*(z[55]*z[151]+z[57]*z[150]-z[53]*z[149]-z[58]*
  z[147])-z[155]*(z[55]*z[76]+z[57]*z[80]-z[53]*z[71]-z[58]*z[78])-z[59]*(
  z[53]*z[180]+z[58]*z[175]+z[71]*z[147]+z[78]*z[149]-z[55]*z[179]-z[57]*
  z[176]-z[76]*z[150]-z[80]*z[151])))/pow(z[59],3);
  z[182] = u*z[172]*q2p + u*z[181]*q3p - z[90]*z[159] - z[89]*z[173];
  z[183] = z[3]*z[43] + ra*z[3]*z[144] + ra*z[4]*z[140] + z[87]*(ra*z[12]*
  z[144]-z[4]*z[5]*z[17]) - ra*z[139] - z[4]*z[17] - z[172]*(k+z[12]*z[17]) - 
  z[156]*(z[10]*z[17]-z[12]*z[43]) - z[61]*(ra*z[12]*z[140]-ra*z[10]*z[144]-
  z[3]*z[5]*z[17]-z[4]*z[5]*z[43]);
  z[184] = ra*z[11]*z[61]*z[144] + z[88]*(ra*z[12]*z[144]-z[4]*z[5]*z[17]) - 
  z[11]*z[17]*z[156] - z[4]*z[6]*z[17]*z[61] - z[181]*(k+z[12]*z[17]);
  z[185] = z[99]*z[159] + u*z[66]*z[163] + u*z[183]*q2p + u*z[184]*q3p + 
  z[98]*z[173] - u*z[95]*z[156] - pow(u,2)*z[162];
  z[186] = (2*z[81]*z[155]*(z[54]*z[58]-z[56]*z[57])-z[59]*(z[168]*(z[54]*
  z[58]-z[56]*z[57])-z[81]*(z[56]*z[151]+z[57]*z[153]-z[54]*z[149]-z[58]*
  z[154])-z[155]*(z[56]*z[75]+z[57]*z[72]-z[54]*z[70]-z[58]*z[68])-z[59]*(
  z[54]*z[171]+z[58]*z[167]+z[68]*z[149]+z[70]*z[154]-z[56]*z[169]-z[57]*
  z[164]-z[72]*z[151]-z[75]*z[153])))/pow(z[59],3);
  z[187] = ra*z[11]*z[140] + z[83]*(ra*z[12]*z[144]-z[4]*z[5]*z[17]) - ra*
  z[9]*z[144] - z[3]*z[6]*z[17] - z[4]*z[6]*z[43] - z[186]*(k+z[12]*z[17]) - 
  z[157]*(z[10]*z[17]-z[12]*z[43]) - z[60]*(ra*z[12]*z[140]-ra*z[10]*z[144]-
  z[3]*z[5]*z[17]-z[4]*z[5]*z[43]);
  z[188] = (2*z[82]*z[155]*(z[54]*z[58]-z[56]*z[57])-z[59]*(z[178]*(z[54]*
  z[58]-z[56]*z[57])-z[82]*(z[56]*z[151]+z[57]*z[153]-z[54]*z[149]-z[58]*
  z[154])-z[155]*(z[56]*z[76]+z[57]*z[73]-z[54]*z[71]-z[58]*z[67])-z[59]*(
  z[54]*z[180]+z[58]*z[177]+z[67]*z[149]+z[71]*z[154]-z[56]*z[179]-z[57]*
  z[174]-z[73]*z[151]-z[76]*z[153])))/pow(z[59],3);
  z[189] = ra*z[12]*z[144] + ra*z[11]*z[60]*z[144] + z[84]*(ra*z[12]*z[144]-
  z[4]*z[5]*z[17]) - z[4]*z[5]*z[17] - z[11]*z[17]*z[157] - z[4]*z[6]*z[17]*
  z[60] - z[188]*(k+z[12]*z[17]);
  z[190] = z[103]*z[159] + u*z[65]*z[163] + pow(u,2)*z[161] + u*z[187]*q2p + 
  u*z[189]*q3p + z[102]*z[173] - u*z[95]*z[157];
  z[191] = z[11]*z[43]*z[156] + ra*z[9]*z[61]*z[144] + ra*z[11]*z[87]*z[144] + 
  z[3]*z[6]*z[17]*z[61] + z[4]*z[6]*z[43]*z[61] + z[157]*(z[45]-z[3]*z[17]-
  z[4]*z[43]) + z[83]*(ra*z[136]-z[3]*z[17]-ra*z[4]*z[144]) - z[9]*z[17]*
  z[156] - z[11]*z[17]*z[172] - ra*z[11]*z[61]*z[140] - z[4]*z[6]*z[17]*z[87] - 
  z[186]*(z[18]-z[4]*z[17]) - z[60]*(ra*z[139]+z[4]*z[17]-z[3]*z[43]-ra*z[3]*
  z[144]-ra*z[4]*z[140]);
  z[192] = z[12]*z[17]*z[156] + ra*z[11]*z[88]*z[144] + z[4]*z[5]*z[17]*z[61] + 
  z[84]*(ra*z[136]-z[3]*z[17]-ra*z[4]*z[144]) - z[11]*z[17]*z[181] - ra*z[12]*
  z[61]*z[144] - z[4]*z[6]*z[17]*z[88] - z[188]*(z[18]-z[4]*z[17]);
  z[193] = z[107]*z[159] + u*z[93]*z[156] + u*z[94]*z[157] + u*z[191]*q2p + u*
  z[192]*q3p + z[106]*z[173] - u*z[65]*z[162] - u*z[66]*z[161];
  z[194] = z[86]*z[159] + z[85]*z[173] - u*z[186]*q2p - u*z[188]*q3p;
  z[195] = z[112]*(z[11]*z[161]+z[4]*z[5]*z[64]-z[3]*z[63]-z[4]*z[162]-z[12]*
  z[163]-z[4]*z[6]*z[62]) + Ix*z[157]*z[91] + Iy*z[61]*z[182] + m*(z[62]*
  z[185]+z[63]*z[190]+z[64]*z[193]+z[161]*z[108]+z[162]*z[109]+z[163]*z[110]) - 
  Ix*z[60]*z[194] - Iy*z[156]*z[92];
  z[196] = 2*Ix*z[60]*z[157] + 2*Iy*z[61]*z[156] - 2*m*(z[62]*z[161]+z[63]*
  z[162]+z[64]*z[163]);
  z[197] = (z[111]*z[195]-z[196]*z[113])/pow(z[111],2);
  z[198] = -z[90]*z[160] - z[52]*z[89]*z[160] - z[87]*q2p - z[88]*q3p;
  z[199] = z[61]*z[95] + z[64]*z[66] + z[99]*z[160] + z[52]*z[98]*z[160] + 
  z[96]*q2p + z[97]*q3p - z[94] - u*z[63];
  z[200] = z[93] + u*z[62] + z[60]*z[95] + z[64]*z[65] + z[103]*z[160] + 
  z[52]*z[102]*z[160] + z[100]*q2p + z[101]*q3p;
  z[201] = z[107]*z[160] + z[52]*z[106]*z[160] + z[104]*q2p + z[105]*q3p - 
  z[60]*z[94] - z[61]*z[93] - z[62]*z[66] - z[63]*z[65];
  z[202] = z[86]*z[160] + z[52]*z[85]*z[160] + z[83]*q2p + z[84]*q3p;
  z[203] = Iy*z[61]*z[198] + m*(z[62]*z[199]+z[63]*z[200]+z[64]*z[201]) - Ix*
  z[60]*z[202];

  p->A[0] = z[52]*z[159] + z[143]*q3p;
  p->A[1] = z[52]*z[160];
  p->A[2] = z[197];
  p->A[3] = z[203]/z[111];
  p->no_cb[0] = q4 - l*z[117] - z[18]*z[116] - z[30]*z[122];
  p->no_cb[1] = q5 + z[18]*z[119] - l*z[120] - z[30]*z[124];
  p->no_cb[2] = z[29] + z[4]*z[18] - z[17] - l*z[12] - z[24]*z[30];
  p->T_da[0] = z[115];
  p->T_da[1] = z[118];
  p->T_da[2] = -z[11];
  p->T_da[4] = -z[116];
  p->T_da[5] = z[119];
  p->T_da[6] = z[4];
  p->T_da[8] = z[117];
  p->T_da[9] = z[120];
  p->T_da[10] = z[12];
  p->T_da[12] = q4 - z[18]*z[116];
  p->T_da[13] = q5 + z[18]*z[119];
  p->T_da[14] = z[4]*z[18] - z[17];
  p->T_db[0] = z[121];
  p->T_db[1] = z[123];
  p->T_db[2] = z[23];
  p->T_db[4] = z[122];
  p->T_db[5] = z[124];
  p->T_db[6] = z[24];
  p->T_db[8] = z[117];
  p->T_db[9] = z[120];
  p->T_db[10] = z[12];
  p->T_db[12] = q4 - l*z[117] - z[18]*z[116];
  p->T_db[13] = q5 + z[18]*z[119] - l*z[120];
  p->T_db[14] = z[4]*z[18] - z[17] - l*z[12];

} // sdOutputs()

void sdSetInertia(sd_t * p)
{
  double Ia, Ib, Ja, Jb;
  Ia = p->m*p->ra*p->ra/4.0;
  Ib = p->m*p->rb*p->rb/4.0;
  Ja = Ia*2.0;
  Jb = Ib*2.0;

  p->Ix = Ia + Ib;
  p->Iy = Ia + Jb + p->ma*p->k*p->k/4.0 + p->mb*pow(p->l - p->k, 2.0)/4.0;
  p->Iz = Ib + Ja + p->ma*p->k*p->k/4.0 + p->mb*pow(p->l - p->k, 2.0)/4.0;
} // sdSetInertia()

void sdPrint(sd_t * p)
{
  int i;
  printf("%5.2f", p->t);
  for (i = 0; i < 6; ++i)
    printf("%12.7f", p->x[i]);
  printf("%12.7f%12.7f%12.7f", p->no_cb[0], p->no_cb[1], p->no_cb[2]);
  printf("%12.7f%12.7f%12.7f", p->ke, p->pe, p->ke + p->pe);
  printf("\n");
}
