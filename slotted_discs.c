#include "slotted_discs.h"

double sdCalcSpin(sd_t * p)
{
  int iter = 0;
  gsl_root_fdfsolver_set(p->fdf_s, &(p->fdf), p->x[2]);
  do
  {
    gsl_root_fdfsolver_iterate(p->fdf_s);
    p->status = gsl_root_test_residual(
                sdConstraint_f(gsl_root_fdfsolver_root(p->fdf_s), p), 1e-14);
  } while (p->status == GSL_CONTINUE && ++iter < 100);

  p->x[2] = gsl_root_fdfsolver_root(p->fdf_s);
  return p->x[2];
} // sdCalcSpin()

double sdConstraint_f(double q3, void * discs)
{
  sd_t * p = (sd_t *) discs;
  return p->rb*(pow(cos(p->alpha),2.0)*pow(sin(q3),2.0)*pow(cos(p->x[1]),2.0)+sin(p->x[1])*(sin(p->x[1])-
  cos(p->alpha)*(cos(p->alpha)*sin(p->x[1])+2.0*sin(p->alpha)*sin(q3)*cos(p->x[1]))))/pow((1.0-pow((
  cos(p->alpha)*sin(p->x[1])+sin(p->alpha)*sin(q3)*cos(p->x[1])),2.0)),0.5) - p->ra*pow(cos(p->x[1]),2.0)/
  fabs(cos(p->x[1])) - cos(p->x[1])*cos(q3)*(p->l-p->rb*cos(p->x[1])*cos(q3)/pow((1-pow((cos(p->alpha)*
  sin(p->x[1])+sin(p->alpha)*sin(q3)*cos(p->x[1])),2.0)),0.5));

} // sdConstraint_f()

double sdConstraint_df(double q3, void * discs)
{
  sd_t * p = (sd_t *) discs;
  return cos(p->x[1])*(sin(q3)*(p->l-2.0*p->rb*cos(p->x[1])*cos(q3)/pow((1.0-pow((cos(p->alpha)*sin(
  p->x[1])+sin(p->alpha)*sin(q3)*cos(p->x[1])),2.0)),0.5))-p->rb*cos(q3)*(2.0*cos(p->alpha)*(sin(
  p->alpha)*sin(p->x[1])-cos(p->alpha)*sin(q3)*cos(p->x[1]))*(1.0-pow((cos(p->alpha)*sin(p->x[1])+sin(
  p->alpha)*sin(q3)*cos(p->x[1])),2.0))-sin(p->alpha)*pow(cos(p->x[1]),2.0)*pow(cos(q3),2.0)*(cos(
  p->alpha)*sin(p->x[1])+sin(p->alpha)*sin(q3)*cos(p->x[1]))-sin(p->alpha)*(cos(p->alpha)*sin(p->x[1])+
  sin(p->alpha)*sin(q3)*cos(p->x[1]))*(pow(cos(p->alpha),2.0)*pow(sin(q3),2.0)*pow(cos(p->x[1]),2.0)+
  sin(p->x[1])*(sin(p->x[1])-cos(p->alpha)*(cos(p->alpha)*sin(p->x[1])+2.0*sin(p->alpha)*sin(q3)*cos(p->x[1])))))/
  pow((1.0-pow((cos(p->alpha)*sin(p->x[1])+sin(p->alpha)*sin(q3)*cos(p->x[1])),2.0)),1.5));
} // sdConstraint_df()

void sdConstraint_fdf(double q3, void * discs, double * f, double * df)
{
  *f = sdConstraint_f(q3, discs);
  *df = sdConstraint_df(q3, discs);
} // sdConstraint_fdf()

void sdFree(sd_t * discs)
{
  gsl_odeiv_evolve_free(discs->e);
  gsl_odeiv_control_free(discs->c);
  gsl_odeiv_step_free(discs->s);
  free(discs);
} // sdFree()

void sdInit(sd_t * p)
{
  // Set default model parameters
  sdInitParameters(p);

  // Set default initial conditions
  sdInitState(p);

  // Set ODE solver
  sdInitOdeSolver(p);

  // Set Newton-Raphson
  //sdInitRootFinder(p);

  /* Evaluate constants */
  p->Ib = 0.25*p->mb*pow(p->rb,2);
  p->z[7] = cos(p->alpha);
  p->Ia = 0.25*p->ma*pow(p->ra,2);
  p->Ja = 0.5*p->ma*pow(p->ra,2);
  p->Jb = 0.5*p->mb*pow(p->rb,2);
  p->z[8] = sin(p->alpha);
  p->z[157] = -p->Ia - p->Ib;
  p->A[0] = 0;
  p->A[3] = 0;
  p->A[4] = 0;
  p->A[6] = 0;
  p->A[9] = 0;
  p->A[10] = 0;
  p->A[12] = 0;
  p->A[15] = 0;
  p->A[16] = 0;
  p->A[21] = 0;
  p->A[22] = 0;
  p->A[27] = 0;
  p->A[28] = 0;
  p->A[30] = 0;
  p->A[33] = 0;
  p->A[34] = 0;

  int i;
  for (i = 0; i < 15; ++i)
    p->T_da[i] = p->T_db[i] = 0.0;
  p->T_da[15] = p->T_db[15] = 1.0;
  for (i = 0; i < 6; ++i)
    p->dfdt[i] = 0.0;
  sdF(p->t, p->x, p->f, p);
  sdOutputs(p);
} // sdInit()

void sdInitOdeSolver(sd_t * p)
{
  p->T = gsl_odeiv_step_rk8pd;
  p->s = gsl_odeiv_step_alloc(p->T, 6);
  p->c = gsl_odeiv_control_y_new(1e-9, 0.0);
  p->e = gsl_odeiv_evolve_alloc(6);
  (p->sys).function = sdF;
  (p->sys).jacobian = sdJ;
  (p->sys).dimension = 6;
  (p->sys).params = p;

  p->t = 0.0;
  p->tf = 5.0;
  p->h = 0.001;
}  // sdInitOdeSolver()

void sdInitParameters(sd_t * p)
{
  p->ra = p->rb = 0.1;
  p->ma = p->mb = 2.0;
  // When l = sqrt(2.0)*r, mass center height is constant
  p->l = sqrt(2.0) * p->ra; //.1;
  p->g = 9.81;
  p->alpha = M_PI / 2.0;
} // sdInitParameters()

void sdInitRootFinder(sd_t * p)
{
  (p->fdf).f = &sdConstraint_f;
  (p->fdf).df = &sdConstraint_df;
  (p->fdf).fdf = &sdConstraint_fdf;
  (p->fdf).params = p;
  p->fdf_t = gsl_root_fdfsolver_newton;
  p->fdf_s = gsl_root_fdfsolver_alloc(p->fdf_t);

  p->x[2] = (M_PI / 2.0) + asin(p->ra / (p->rb + p->l));
  gsl_root_fdfsolver_set(p->fdf_s, &(p->fdf), p->x[2]);
} // sdInitRootFinder()

void sdInitState(sd_t * p)
{
  p->x[0] = 0.0; // Yaw
  p->x[1] = M_PI / 4.0; // Lean
  p->x[2] = M_PI / 2.0; // Spin
  p->x[3] = 0.0; // x of contact point of disc A
  p->x[4] = 0.0; // y of contact point of disc A
  p->x[5] = 1.0; // body fixed angular velocity along connecting axis
} // sdInitState()

int sdF(double t, const double *x, double *f, void *params)
{
  sd_t * p = (sd_t *) params;
  double q1 = x[0];  // Yaw
  double q2 = x[1];  // Lean
  double q3 = x[2];  // Spin
  double w3 = x[5];
  double q1p, q2p, q3p, q4p, q5p, w3p, * z = p->z,
         ra = p->ra,
         rb = p->rb,
         l = p->l,
         Ia = p->Ia,
         Ib = p->Ib,
         Ja = p->Ja,
         Jb = p->Jb,
         ma = p->ma,
         mb = p->mb,
         g = p->g;

  z[5] = cos(q3);
  z[6] = sin(q3);
  z[3] = cos(q2);
  z[11] = z[3]*z[6];
  z[4] = sin(q2);
  z[13] = 1 - pow(z[4],2);
  z[14] = pow(z[13],0.5);
  z[15] = 1/z[14];
  z[17] = ra*z[11]*z[15];
  z[12] = z[3]*z[5];
  z[19] = ra*z[12]*z[15];
  z[25] = z[7]*z[4] + z[8]*z[11];
  z[26] = 1 - pow(z[25],2);
  z[27] = pow(z[26],0.5);
  z[28] = 1/z[27];
  z[32] = rb*z[12]*z[28];
  z[24] = z[8]*z[4] - z[7]*z[11];
  z[30] = rb*z[24]*z[28];
  z[29] = z[25]/z[27];
  z[31] = rb*(z[29]-z[25]*z[28]);
  z[34] = -z[6]*z[17] - z[5]*(l+z[19]-z[32]) - z[6]*(z[7]*z[30]+z[8]*z[31]);
  z[16] = z[4]/z[14];
  z[18] = ra*(z[16]-z[4]*z[15]);
  z[38] = -z[4]*z[17] - z[11]*z[18] - z[24]*z[31] - z[25]*z[30];
  z[36] = z[11]*(l+z[19]-z[32]) - z[12]*z[17] - z[12]*(z[7]*z[30]+z[8]*z[31]);
  z[21] = z[8]*z[5];
  z[20] = z[7]*z[5];
  z[37] = z[5]*z[18] + z[21]*z[30] - z[20]*z[31];
  z[33] = z[6]*(z[7]*z[31]-z[18]-z[8]*z[30]);
  z[35] = z[12]*z[18] + z[4]*(l+z[19]-z[32]) - z[12]*(z[7]*z[31]-z[8]*z[30]);
  z[39] = -z[33]*z[36] - z[34]*z[35];
  z[40] = (z[34]*z[38]-z[36]*z[37])/z[39];
  z[42] = (z[5]+z[6]*z[40])/z[3];
  q1p = w3*z[42];
  z[43] = z[6] - z[5]*z[40];
  q2p = w3*z[43];
  z[10] = z[4]*z[5];
  z[9] = z[4]*z[6];
  z[23] = z[7]*z[3] - z[8]*z[9];
  z[53] = z[23]*z[25];
  z[55] = z[53]/pow(z[26],0.5);
  z[57] = z[55]/pow(z[27],2);
  z[65] = rb*(z[10]*z[28]-z[12]*z[57]);
  z[61] = (z[23]*z[27]+z[25]*z[55])/pow(z[27],2);
  z[63] = rb*(z[61]-z[23]*z[28]-z[25]*z[57]);
  z[44] = z[3]*z[4];
  z[45] = z[44]/pow(z[13],0.5);
  z[48] = (z[3]*z[14]+z[4]*z[45])/pow(z[14],2);
  z[46] = z[45]/pow(z[14],2);
  z[49] = ra*(z[48]-z[3]*z[15]-z[4]*z[46]);
  z[47] = ra*(z[9]*z[15]-z[11]*z[46]);
  z[50] = ra*(z[10]*z[15]-z[12]*z[46]);
  z[22] = z[7]*z[9] + z[8]*z[3];
  z[59] = rb*(z[22]*z[28]+z[24]*z[57]);
  z[68] = z[10]*z[32] + z[12]*z[65] + z[23]*z[31] + z[25]*z[63] - z[3]*z[18] - 
  z[4]*z[49] - z[9]*z[17] - z[11]*z[47] - z[12]*z[50] - z[22]*z[30] - z[24]*
  z[59] - z[10]*(l+z[19]);
  z[52] = z[8]*z[12];
  z[54] = z[25]*z[52];
  z[56] = z[54]/pow(z[26],0.5);
  z[58] = z[56]/pow(z[27],2);
  z[51] = z[7]*z[12];
  z[60] = rb*(z[24]*z[58]-z[28]*z[51]);
  z[66] = rb*(z[11]*z[28]-z[12]*z[58]);
  z[62] = (z[25]*z[56]+z[27]*z[52])/pow(z[27],2);
  z[64] = rb*(z[62]-z[25]*z[58]-z[28]*z[52]);
  z[67] = l*z[11] + z[24]*z[60] - z[11]*z[32] - z[12]*z[66] - z[25]*z[64] - 
  z[30]*z[51] - z[31]*z[52];
  z[69] = z[68]/z[67];
  z[70] = z[43]*z[69];
  q3p = w3*z[70];
  z[1] = cos(q1);
  z[2] = sin(q1);
  z[71] = z[70]*(z[17]*(z[1]*z[6]+z[2]*z[10])+z[19]*(z[1]*z[5]-z[2]*z[9]));
  q4p = -w3*z[71];
  z[72] = z[70]*(z[19]*(z[1]*z[9]+z[2]*z[5])-z[17]*(z[1]*z[10]-z[2]*z[6]));
  q5p = -w3*z[72];
  z[41] = (z[33]*z[38]+z[35]*z[37])/z[39];
  z[73] = -z[7]*z[40] - z[8]*z[41];
  z[87] = z[10]*z[17] + z[12]*z[47] + z[10]*(z[7]*z[30]+z[8]*z[31]) - z[11]*(
  z[50]-z[65]) - z[9]*(l+z[19]-z[32]) - z[12]*(z[7]*z[59]+z[8]*z[63]);
  z[95] = z[12]*z[49] + z[3]*(l+z[19]-z[32]) + z[10]*(z[7]*z[31]-z[8]*z[30]) - 
  z[10]*z[18] - z[4]*(z[50]-z[65]) - z[12]*(z[7]*z[63]-z[8]*z[59]);
  z[84] = z[6]*z[47] + z[5]*(z[50]-z[65]) - z[6]*(z[7]*z[59]+z[8]*z[63]);
  z[94] = z[6]*(z[7]*z[63]-z[49]-z[8]*z[59]);
  z[97] = -z[33]*z[87] - z[34]*z[95] - z[35]*z[84] - z[36]*z[94];
  z[91] = z[5]*z[49] + z[21]*z[59] - z[20]*z[63];
  z[85] = z[4]*z[47] + z[9]*z[18] - z[3]*z[17] - z[11]*z[49] - z[22]*z[31] - 
  z[23]*z[30] - z[24]*z[63] - z[25]*z[59];
  z[99] = (z[97]*(z[34]*z[38]-z[36]*z[37])+z[39]*(z[36]*z[91]+z[37]*z[87]-
  z[34]*z[85]-z[38]*z[84]))/pow(z[39],2);
  z[103] = (z[97]*(z[33]*z[38]+z[35]*z[37])-z[39]*(z[33]*z[85]+z[35]*z[91]+
  z[37]*z[95]+z[38]*z[94]))/pow(z[39],2);
  z[111] = z[7]*z[99] + z[8]*z[103];
  z[113] = w3*z[111];
  z[88] = z[11]*z[66] + z[12]*(l-z[32]) + z[11]*(z[7]*z[30]+z[8]*z[31]) - 
  z[12]*(z[7]*z[60]+z[8]*z[64]);
  z[96] = z[11]*(z[7]*z[31]-z[8]*z[30]) - z[11]*z[18] - z[4]*(z[17]-z[66]) - 
  z[12]*(z[7]*z[64]-z[8]*z[60]);
  z[83] = z[6]*(l-z[32]) - z[5]*z[66] - z[5]*(z[7]*z[30]+z[8]*z[31]) - z[6]*(
  z[7]*z[60]+z[8]*z[64]);
  z[93] = z[6]*(z[7]*z[64]-z[8]*z[60]) + z[5]*(z[7]*z[31]-z[18]-z[8]*z[30]);
  z[98] = -z[33]*z[88] - z[34]*z[96] - z[35]*z[83] - z[36]*z[93];
  z[90] = z[7]*z[6];
  z[89] = z[8]*z[6];
  z[92] = z[21]*z[60] + z[31]*z[90] - z[6]*z[18] - z[20]*z[64] - z[30]*z[89];
  z[86] = z[31]*z[51] - z[4]*z[19] - z[12]*z[18] - z[24]*z[64] - z[25]*z[60] - 
  z[30]*z[52];
  z[100] = (z[98]*(z[34]*z[38]-z[36]*z[37])+z[39]*(z[36]*z[92]+z[37]*z[88]-
  z[34]*z[86]-z[38]*z[83]))/pow(z[39],2);
  z[104] = (z[98]*(z[33]*z[38]+z[35]*z[37])-z[39]*(z[33]*z[86]+z[35]*z[92]+
  z[37]*z[96]+z[38]*z[93]))/pow(z[39],2);
  z[112] = z[7]*z[100] + z[8]*z[104];
  z[114] = w3*z[112];
  z[119] = z[113]*q2p + z[114]*q3p;
  z[74] = z[8]*z[40] - z[7]*z[41];
  z[115] = z[7]*z[103] - z[8]*z[99];
  z[117] = w3*z[115];
  z[116] = z[7]*z[104] - z[8]*z[100];
  z[118] = w3*z[116];
  z[120] = z[117]*q2p + z[118]*q3p;
  z[75] = z[19]*z[41] - z[18];
  z[124] = -z[49] - z[19]*z[103] - z[41]*z[50];
  z[126] = w3*z[124];
  z[125] = -z[17]*z[41] - z[19]*z[104];
  z[127] = w3*z[125];
  z[76] = z[17] - z[19]*z[40];
  z[77] = z[17]*z[41] - z[18]*z[40];
  z[136] = z[126]*q2p + z[127]*q3p - pow(w3,2)*z[76] - pow(w3,2)*z[41]*z[77];
  z[128] = z[19] + z[17]*z[40] + z[19]*z[100];
  z[130] = w3*z[128];
  z[129] = z[19]*z[99] + z[40]*z[50] - z[47];
  z[131] = w3*z[129];
  z[137] = pow(w3,2)*z[75] + pow(w3,2)*z[40]*z[77] + z[130]*q3p + z[131]*q2p;
  z[132] = z[18]*z[99] - z[17]*z[103] - z[40]*z[49] - z[41]*z[47];
  z[134] = w3*z[132];
  z[133] = z[18]*z[100] + z[19]*z[41] - z[17]*z[104];
  z[135] = w3*z[133];
  z[138] = pow(w3,2)*z[41]*z[75] + z[134]*q2p + z[135]*q3p - pow(w3,2)*z[40]*
  z[76];
  z[78] = -z[31] - z[32]*z[74];
  z[80] = z[30]*z[74] + z[31]*z[73];
  z[142] = z[65]*z[74] - z[63] - z[32]*z[115];
  z[144] = w3*z[142];
  z[143] = z[66]*z[74] - z[64] - z[32]*z[116];
  z[145] = w3*z[143];
  z[79] = z[32]*z[73] - z[30];
  z[154] = pow(w3,2)*z[74]*z[80] + z[144]*q2p + z[145]*q3p - pow(w3,2)*z[79];
  z[146] = z[32]*z[111] - z[59] - z[65]*z[73];
  z[148] = w3*z[146];
  z[147] = z[32]*z[112] - z[60] - z[66]*z[73];
  z[149] = w3*z[147];
  z[155] = pow(w3,2)*z[78] + z[148]*q2p + z[149]*q3p - pow(w3,2)*z[73]*z[80];
  z[150] = z[30]*z[115] + z[31]*z[111] + z[59]*z[74] + z[63]*z[73];
  z[152] = w3*z[150];
  z[151] = z[30]*z[116] + z[31]*z[112] + z[60]*z[74] + z[64]*z[73];
  z[153] = w3*z[151];
  z[156] = pow(w3,2)*z[73]*z[79] + z[152]*q2p + z[153]*q3p - pow(w3,2)*z[74]*
  z[78];
  z[101] = w3*z[99];
  z[102] = w3*z[100];
  z[107] = z[101]*q2p + z[102]*q3p;
  z[105] = w3*z[103];
  z[106] = w3*z[104];
  z[108] = z[105]*q2p + z[106]*q3p;
  z[159] = Ib*z[73]*z[119] + Jb*z[74]*z[120] + ma*(z[75]*z[136]+z[76]*z[137]+
  z[77]*z[138]) + mb*(z[78]*z[154]+z[79]*z[155]+z[80]*z[156]) - g*(mb*(z[12]*
  z[80]+z[24]*z[78]+z[25]*z[79])-ma*(z[11]*z[75]-z[4]*z[76]-z[12]*z[77])) - 
  Ia*z[40]*z[107] - Ja*z[41]*z[108];
  z[158] = z[157] - Ia*pow(z[40],2) - Ib*pow(z[73],2) - Ja*pow(z[41],2) - Jb*
  pow(z[74],2) - ma*(pow(z[75],2)+pow(z[76],2)+pow(z[77],2)) - mb*(pow(z[78],
  2)+pow(z[79],2)+pow(z[80],2));
  z[160] = z[159]/z[158];
  w3p = z[160];

  f[0] = q1p;
  f[1] = q2p;
  f[2] = q3p;
  f[3] = q4p;
  f[4] = q5p;
  f[5] = w3p;

  return GSL_SUCCESS;
} // sdF()

int sdJ(double t, const double * x, double * dfdx, double *dfdt, void * params)
{
  sd_t * p = (sd_t *) params;
  sdF(t, x, p->f, p);
  sdOutputs(p);
  dfdx = p->A;
  dfdt = p->dfdt;
  return GSL_SUCCESS;
} // sdJ()

void sdOutputs(sd_t * p)
{
  double *z = p->z,
         q2p = p->f[1],
         q3p = p->f[2],
         q4 = p->x[3],
         q5 = p->x[4],
         w3 = p->x[5],
         ra = p->ra,
         rb = p->rb,
         ma = p->ma,
         mb = p->mb,
         Ia = p->Ia,
         Ib = p->Ib,
         Ja = p->Ja,
         Jb = p->Jb,
         l = p->l,
         g = p->g;

  double w1, w2;
  w1 = -w3*z[40];
  w2 = -w3*z[41];
  p->ke = 0.5*pow(w3,2)*(Ia+Ib+Ia*pow(z[40],2)+Ib*pow(z[73],2)+Ja*pow(z[41],2)+
  Jb*pow(z[74],2)+ma*(pow(z[75],2)+pow(z[76],2)+pow(z[77],2))+mb*(pow(z[78],2)+
  pow(z[79],2)+pow(z[80],2)));
  p->pe = -g*(ma*(z[4]*z[18]-z[11]*z[17]-z[12]*z[19])+mb*(z[4]*z[18]-z[11]*z[17]-
  z[12]*(l+z[19])));
  z[161] = z[1]*z[5] - z[2]*z[9];
  z[162] = z[2]*z[3];
  z[163] = z[1]*z[6] + z[2]*z[10];
  z[164] = z[1]*z[9] + z[2]*z[5];
  z[165] = z[1]*z[3];
  z[166] = z[2]*z[6] - z[1]*z[10];
  z[167] = z[1]*z[20] - z[2]*z[22];
  z[168] = -z[1]*z[21] - z[2]*z[23];
  z[169] = z[1]*z[22] + z[2]*z[20];
  z[170] = z[1]*z[23] - z[2]*z[21];
  z[171] = z[3]*z[4]/(pow(z[13],0.5)*pow(z[14],2));
  z[172] = ra*(z[11]*z[171]-z[4]*z[6]*z[15]);
  z[173] = ra*(z[12]*z[171]-z[4]*z[5]*z[15]);
  z[174] = z[7]*z[3] - z[8]*z[4]*z[6];
  z[175] = z[25]*z[174]/(pow(z[26],0.5)*pow(z[27],2));
  z[176] = rb*(z[12]*z[175]-z[4]*z[5]*z[28]);
  z[177] = z[8]*z[3] + z[7]*z[4]*z[6];
  z[178] = rb*(z[24]*z[175]+z[28]*z[177]);
  z[179] = z[174]*(z[27]+pow(z[25],2)/pow(z[26],0.5))/pow(z[27],2);
  z[180] = rb*(z[179]-z[25]*z[175]-z[28]*z[174]);
  z[181] = -z[6]*z[172] - z[5]*(z[173]-z[176]) - z[6]*(z[7]*z[178]+z[8]*
  z[180]);
  z[182] = z[3]*(z[14]+pow(z[4],2)/pow(z[13],0.5))/pow(z[14],2);
  z[183] = ra*(z[182]-z[3]*z[15]-z[4]*z[171]);
  z[184] = z[4]*z[6]*z[18] - z[3]*z[17] - z[4]*z[172] - z[11]*z[183] - z[24]*
  z[180] - z[25]*z[178] - z[30]*z[174] - z[31]*z[177];
  z[185] = z[4]*z[5]*z[17] + z[11]*(z[173]-z[176]) + z[4]*z[5]*(z[7]*z[30]+
  z[8]*z[31]) - z[12]*z[172] - z[12]*(z[7]*z[178]+z[8]*z[180]) - z[4]*z[6]*(l+
  z[19]-z[32]);
  z[186] = z[5]*z[183] + z[21]*z[178] - z[20]*z[180];
  z[187] = z[6]*(z[7]*z[180]-z[183]-z[8]*z[178]);
  z[188] = z[12]*z[183] + z[4]*(z[173]-z[176]) + z[3]*(l+z[19]-z[32]) + z[4]*
  z[5]*(z[7]*z[31]-z[8]*z[30]) - z[4]*z[5]*z[18] - z[12]*(z[7]*z[180]-z[8]*
  z[178]);
  z[189] = -z[33]*z[185] - z[34]*z[188] - z[35]*z[181] - z[36]*z[187];
  z[190] = (z[189]*(z[34]*z[38]-z[36]*z[37])+z[39]*(z[36]*z[186]+z[37]*z[185]-
  z[34]*z[184]-z[38]*z[181]))/pow(z[39],2);
  z[191] = (z[3]*z[6]*z[190]-z[4]*(z[5]+z[6]*z[40]))/pow(z[3],2);
  z[192] = ra*z[3]*z[5]*z[15];
  z[193] = ra*z[3]*z[6]*z[15];
  z[194] = z[8]*z[3]*z[5]*z[25];
  z[195] = rb*(z[3]*z[6]*z[28]-z[12]*z[194]/(pow(z[26],0.5)*pow(z[27],2)));
  z[196] = rb*(z[7]*z[3]*z[5]*z[28]-z[24]*z[194]/(pow(z[26],0.5)*pow(z[27],2)));
  z[197] = (z[8]*z[3]*z[5]*z[27]+z[25]*z[194]/pow(z[26],0.5))/pow(z[27],2);
  z[198] = rb*(z[197]-z[8]*z[3]*z[5]*z[28]-z[25]*z[194]/(pow(z[26],0.5)*pow(
  z[27],2)));
  z[199] = z[5]*(z[193]-z[195]) + z[6]*(l+z[19]-z[32]) + z[6]*(z[7]*z[196]-
  z[8]*z[198]) - z[5]*z[17] - z[6]*z[192] - z[5]*(z[7]*z[30]+z[8]*z[31]);
  z[200] = z[25]*z[196] + z[7]*z[3]*z[5]*z[31] - z[4]*z[192] - z[24]*z[198] - 
  z[3]*z[5]*z[18] - z[8]*z[3]*z[5]*z[30];
  z[201] = z[3]*z[6]*z[17] + z[3]*z[5]*(l+z[19]-z[32]) + z[3]*z[6]*(z[7]*
  z[30]+z[8]*z[31]) + z[12]*(z[7]*z[196]-z[8]*z[198]) - z[12]*z[192] - z[11]*(
  z[193]-z[195]);
  z[202] = z[7]*z[6]*z[31] - z[6]*z[18] - z[20]*z[198] - z[21]*z[196] - z[8]*
  z[6]*z[30];
  z[203] = z[6]*(z[7]*z[198]+z[8]*z[196]) + z[5]*(z[7]*z[31]-z[18]-z[8]*z[30]);
  z[204] = z[3]*z[6]*(z[7]*z[31]-z[8]*z[30]) - z[3]*z[6]*z[18] - z[4]*(z[193]-
  z[195]) - z[12]*(z[7]*z[198]+z[8]*z[196]);
  z[205] = -z[33]*z[201] - z[34]*z[204] - z[35]*z[199] - z[36]*z[203];
  z[206] = (z[205]*(z[34]*z[38]-z[36]*z[37])+z[39]*(z[36]*z[202]+z[37]*z[201]-
  z[34]*z[200]-z[38]*z[199]))/pow(z[39],2);
  z[207] = (z[5]*z[40]-z[6]-z[6]*z[206])/z[3];
  z[208] = z[5] + z[5]*z[206] + z[6]*z[40];
  z[209] = -z[7]*z[4] - z[8]*z[3]*z[6];
  z[210] = z[23]*z[174] + z[25]*z[209];
  z[211] = (z[26]*z[210]+z[25]*z[53]*z[174])/pow(z[26],1.5);
  z[212] = (z[27]*z[211]+2*z[25]*z[55]*z[174]/pow(z[26],0.5))/pow(z[27],3);
  z[213] = rb*(z[12]*z[212]-z[10]*z[175]-z[3]*z[5]*z[28]-z[4]*z[5]*z[57]);
  z[214] = (z[27]*(z[25]*z[211]+z[27]*z[209]+z[55]*z[174])+z[25]*z[174]*(
  z[23]*z[27]+2*z[25]*z[55])/pow(z[26],0.5))/pow(z[27],3);
  z[215] = rb*(z[214]-z[23]*z[175]-z[25]*z[212]-z[28]*z[209]-z[57]*z[174]);
  z[216] = pow(z[3],2) - pow(z[4],2);
  z[217] = (z[13]*z[216]+z[3]*z[4]*z[44])/pow(z[13],1.5);
  z[218] = (z[3]*z[4]*(z[3]*z[14]+2*z[4]*z[45])/pow(z[13],0.5)-z[14]*(z[4]*
  z[14]-z[3]*z[45]-z[4]*z[217]))/pow(z[14],3);
  z[219] = (z[14]*z[217]+2*z[3]*z[4]*z[45]/pow(z[13],0.5))/pow(z[14],3);
  z[220] = ra*(z[218]+z[4]*z[15]-z[3]*z[46]-z[3]*z[171]-z[4]*z[219]);
  z[221] = ra*(z[11]*z[219]-z[9]*z[171]-z[3]*z[6]*z[15]-z[4]*z[6]*z[46]);
  z[222] = ra*(z[12]*z[219]-z[10]*z[171]-z[3]*z[5]*z[15]-z[4]*z[5]*z[46]);
  z[223] = z[7]*z[3]*z[6] - z[8]*z[4];
  z[224] = rb*(z[22]*z[175]+z[24]*z[212]+z[28]*z[223]+z[57]*z[177]);
  z[225] = z[4]*z[18] + z[10]*z[176] + z[11]*z[221] + z[12]*z[222] + z[23]*
  z[180] + z[25]*z[215] + z[31]*z[209] + z[63]*z[174] + z[3]*z[5]*z[32] + 
  z[4]*z[5]*z[50] + z[4]*z[6]*z[47] - z[3]*z[49] - z[3]*z[183] - z[4]*z[220] - 
  z[9]*z[172] - z[10]*z[173] - z[12]*z[213] - z[22]*z[178] - z[24]*z[224] - 
  z[30]*z[223] - z[59]*z[177] - z[3]*z[6]*z[17] - z[4]*z[5]*z[65] - z[3]*z[5]*(
  l+z[19]);
  z[226] = z[52]*z[174] - z[8]*z[4]*z[5]*z[25];
  z[227] = (z[26]*z[226]+z[25]*z[54]*z[174])/pow(z[26],1.5);
  z[228] = (z[27]*z[227]+2*z[25]*z[56]*z[174]/pow(z[26],0.5))/pow(z[27],3);
  z[229] = rb*(z[51]*z[175]-z[24]*z[228]-z[58]*z[177]-z[7]*z[4]*z[5]*z[28]);
  z[230] = rb*(z[11]*z[175]+z[4]*z[5]*z[58]-z[12]*z[228]-z[4]*z[6]*z[28]);
  z[231] = (z[25]*z[174]*(z[27]*z[52]+2*z[25]*z[56])/pow(z[26],0.5)+z[27]*(
  z[25]*z[227]+z[56]*z[174]-z[8]*z[4]*z[5]*z[27]))/pow(z[27],3);
  z[232] = rb*(z[25]*z[228]+z[52]*z[175]+z[58]*z[174]-z[231]-z[8]*z[4]*z[5]*
  z[28]);
  z[233] = z[25]*z[232] + z[60]*z[177] + z[4]*z[5]*z[66] + z[4]*z[6]*z[32] + 
  z[7]*z[4]*z[5]*z[30] + z[8]*z[4]*z[5]*z[31] - z[11]*z[176] - z[12]*z[230] - 
  z[24]*z[229] - z[51]*z[178] - z[52]*z[180] - z[64]*z[174] - l*z[4]*z[6];
  z[234] = (z[67]*z[225]-z[68]*z[233])/pow(z[67],2);
  z[235] = z[43]*z[234] + z[5]*z[69]*z[190];
  z[236] = z[8]*z[5]*(z[3]*z[23]-z[4]*z[25]);
  z[237] = (z[26]*z[236]+z[53]*z[194])/pow(z[26],1.5);
  z[238] = (z[27]*z[237]+2*z[55]*z[194]/pow(z[26],0.5))/pow(z[27],3);
  z[239] = rb*(z[12]*z[238]+z[4]*z[6]*z[28]-z[3]*z[6]*z[57]-z[10]*z[194]/(
  pow(z[26],0.5)*pow(z[27],2)));
  z[240] = (z[194]*(z[23]*z[27]+2*z[25]*z[55])/pow(z[26],0.5)+z[27]*(z[25]*
  z[237]+z[8]*z[3]*z[5]*z[55]-z[8]*z[4]*z[5]*z[27]))/pow(z[27],3);
  z[241] = rb*(z[240]+z[8]*z[4]*z[5]*z[28]-z[25]*z[238]-z[8]*z[3]*z[5]*z[57]-
  z[23]*z[194]/(pow(z[26],0.5)*pow(z[27],2)));
  z[242] = ra*z[5]*(z[3]*z[46]-z[4]*z[15]);
  z[243] = ra*z[6]*(z[3]*z[46]-z[4]*z[15]);
  z[244] = rb*(z[7]*z[3]*z[5]*z[57]-z[24]*z[238]-z[7]*z[4]*z[5]*z[28]-z[22]*
  z[194]/(pow(z[26],0.5)*pow(z[27],2)));
  z[245] = z[10]*z[193] + z[11]*z[242] + z[22]*z[196] + z[23]*z[198] + z[24]*
  z[244] + z[25]*z[241] + z[3]*z[6]*z[50] + z[7]*z[3]*z[5]*z[59] + z[8]*z[3]*
  z[5]*z[63] + z[4]*z[6]*(l+z[19]) - z[9]*z[192] - z[10]*z[195] - z[12]*
  z[239] - z[12]*z[243] - z[3]*z[5]*z[47] - z[3]*z[6]*z[65] - z[4]*z[5]*z[17] - 
  z[4]*z[6]*z[32] - z[7]*z[4]*z[5]*z[30] - z[8]*z[4]*z[5]*z[31];
  z[246] = z[8]*z[3]*(z[5]*z[52]-z[6]*z[25]);
  z[247] = (z[26]*z[246]+z[54]*z[194])/pow(z[26],1.5);
  z[248] = (z[27]*z[247]+2*z[56]*z[194]/pow(z[26],0.5))/pow(z[27],3);
  z[249] = rb*(z[24]*z[248]+z[7]*z[3]*z[6]*z[28]-z[7]*z[3]*z[5]*z[58]-z[51]*
  z[194]/(pow(z[26],0.5)*pow(z[27],2)));
  z[250] = rb*(z[12]*z[248]-z[3]*z[5]*z[28]-z[3]*z[6]*z[58]-z[11]*z[194]/(
  pow(z[26],0.5)*pow(z[27],2)));
  z[251] = (z[194]*(z[27]*z[52]+2*z[25]*z[56])/pow(z[26],0.5)+z[27]*(z[25]*
  z[247]+z[8]*z[3]*z[5]*z[56]-z[8]*z[3]*z[6]*z[27]))/pow(z[27],3);
  z[252] = rb*(z[251]+z[8]*z[3]*z[6]*z[28]-z[25]*z[248]-z[8]*z[3]*z[5]*z[58]-
  z[52]*z[194]/(pow(z[26],0.5)*pow(z[27],2)));
  z[253] = z[11]*z[195] + z[12]*z[250] + z[24]*z[249] + z[51]*z[196] + l*z[3]*
  z[5] + z[3]*z[6]*z[66] + z[7]*z[3]*z[6]*z[30] + z[8]*z[3]*z[6]*z[31] - 
  z[25]*z[252] - z[52]*z[198] - z[3]*z[5]*z[32] - z[7]*z[3]*z[5]*z[60] - z[8]*
  z[3]*z[5]*z[64];
  z[254] = (z[67]*z[245]-z[68]*z[253])/pow(z[67],2);
  z[255] = z[43]*z[254] + z[69]*z[208];
  z[256] = z[235]*(z[17]*(z[1]*z[6]+z[2]*z[10])+z[19]*(z[1]*z[5]-z[2]*z[9])) - 
  z[70]*(z[2]*z[3]*z[6]*z[19]-z[2]*z[3]*z[5]*z[17]-z[172]*(z[1]*z[6]+z[2]*
  z[10])-z[173]*(z[1]*z[5]-z[2]*z[9]));
  z[257] = z[255]*(z[17]*(z[1]*z[6]+z[2]*z[10])+z[19]*(z[1]*z[5]-z[2]*z[9])) - 
  z[70]*(z[19]*(z[1]*z[6]+z[2]*z[4]*z[5])+z[193]*(z[1]*z[5]-z[2]*z[9])-z[192]*(
  z[1]*z[6]+z[2]*z[10])-z[17]*(z[1]*z[5]-z[2]*z[4]*z[6]));
  z[258] = z[235]*(z[19]*(z[1]*z[9]+z[2]*z[5])-z[17]*(z[1]*z[10]-z[2]*z[6])) + 
  z[70]*(z[1]*z[3]*z[6]*z[19]+z[173]*(z[1]*z[9]+z[2]*z[5])-z[1]*z[3]*z[5]*
  z[17]-z[172]*(z[1]*z[10]-z[2]*z[6]));
  z[259] = z[255]*(z[19]*(z[1]*z[9]+z[2]*z[5])-z[17]*(z[1]*z[10]-z[2]*z[6])) + 
  z[70]*(z[17]*(z[2]*z[5]+z[1]*z[4]*z[6])-z[193]*(z[1]*z[9]+z[2]*z[5])-z[192]*(
  z[1]*z[10]-z[2]*z[6])-z[19]*(z[2]*z[6]-z[1]*z[4]*z[5]));
  z[260] = (z[189]*(z[33]*z[38]+z[35]*z[37])-z[39]*(z[33]*z[184]+z[35]*z[186]+
  z[37]*z[188]+z[38]*z[187]))/pow(z[39],2);
  z[261] = z[7]*z[190] + z[8]*z[260];
  z[262] = z[10]*z[172] + z[3]*z[5]*z[17] + z[4]*z[6]*(z[50]-z[65]) + z[10]*(
  z[7]*z[178]+z[8]*z[180]) + z[3]*z[5]*(z[7]*z[30]+z[8]*z[31]) + z[4]*z[5]*(
  z[7]*z[59]+z[8]*z[63]) - z[12]*z[221] - z[4]*z[5]*z[47] - z[9]*(z[173]-
  z[176]) - z[11]*(z[213]-z[222]) - z[12]*(z[7]*z[224]+z[8]*z[215]) - z[3]*
  z[6]*(l+z[19]-z[32]);
  z[263] = z[12]*z[220] + z[3]*(z[173]-z[176]) + z[10]*(z[7]*z[180]-z[8]*
  z[178]) + z[3]*z[5]*(z[7]*z[31]-z[8]*z[30]) + z[4]*z[5]*(z[7]*z[63]-z[8]*
  z[59]) - z[10]*z[183] - z[3]*z[5]*z[18] - z[4]*z[5]*z[49] - z[3]*(z[50]-
  z[65]) - z[4]*(z[213]-z[222]) - z[4]*(l+z[19]-z[32]) - z[12]*(z[7]*z[215]-
  z[8]*z[224]);
  z[264] = z[5]*(z[213]-z[222]) - z[6]*z[221] - z[6]*(z[7]*z[224]+z[8]*z[215]);
  z[265] = z[6]*(z[7]*z[215]-z[220]-z[8]*z[224]);
  z[266] = -z[33]*z[262] - z[34]*z[263] - z[35]*z[264] - z[36]*z[265] - z[84]*
  z[188] - z[87]*z[187] - z[94]*z[185] - z[95]*z[181];
  z[267] = z[5]*z[220] + z[21]*z[224] - z[20]*z[215];
  z[268] = z[3]*z[47] + z[4]*z[17] + z[9]*z[183] + z[3]*z[6]*z[18] + z[4]*
  z[6]*z[49] - z[3]*z[172] - z[4]*z[221] - z[11]*z[220] - z[22]*z[180] - 
  z[23]*z[178] - z[24]*z[215] - z[25]*z[224] - z[30]*z[209] - z[31]*z[223] - 
  z[59]*z[174] - z[63]*z[177];
  z[269] = (2*z[97]*z[189]*(z[34]*z[38]-z[36]*z[37])-z[39]*(z[266]*(z[34]*
  z[38]-z[36]*z[37])-z[97]*(z[36]*z[186]+z[37]*z[185]-z[34]*z[184]-z[38]*
  z[181])-z[189]*(z[36]*z[91]+z[37]*z[87]-z[34]*z[85]-z[38]*z[84])-z[39]*(
  z[34]*z[268]+z[38]*z[264]+z[84]*z[184]+z[85]*z[181]-z[36]*z[267]-z[37]*
  z[262]-z[87]*z[186]-z[91]*z[185])))/pow(z[39],3);
  z[270] = (2*z[97]*z[189]*(z[33]*z[38]+z[35]*z[37])-z[39]*(z[266]*(z[33]*
  z[38]+z[35]*z[37])+z[97]*(z[33]*z[184]+z[35]*z[186]+z[37]*z[188]+z[38]*
  z[187])+z[189]*(z[33]*z[85]+z[35]*z[91]+z[37]*z[95]+z[38]*z[94])-z[39]*(
  z[33]*z[268]+z[35]*z[267]+z[37]*z[263]+z[38]*z[265]+z[85]*z[187]+z[91]*
  z[188]+z[94]*z[184]+z[95]*z[186])))/pow(z[39],3);
  z[271] = -z[7]*z[269] - z[8]*z[270];
  z[272] = z[11]*z[230] + z[11]*(z[7]*z[178]+z[8]*z[180]) + z[12]*(z[7]*
  z[229]+z[8]*z[232]) + z[4]*z[5]*(z[7]*z[60]+z[8]*z[64]) - z[12]*z[176] - 
  z[4]*z[6]*z[66] - z[4]*z[5]*(l-z[32]) - z[4]*z[6]*(z[7]*z[30]+z[8]*z[31]);
  z[273] = z[4]*z[6]*z[18] + z[11]*(z[7]*z[180]-z[8]*z[178]) + z[12]*(z[7]*
  z[232]-z[8]*z[229]) + z[4]*z[5]*(z[7]*z[64]-z[8]*z[60]) - z[11]*z[183] - 
  z[3]*(z[17]-z[66]) - z[4]*(z[172]-z[230]) - z[4]*z[6]*(z[7]*z[31]-z[8]*
  z[30]);
  z[274] = z[6]*(z[7]*z[229]+z[8]*z[232]) - z[5]*z[230] - z[6]*z[176] - z[5]*(
  z[7]*z[178]+z[8]*z[180]);
  z[275] = z[5]*(z[7]*z[180]-z[183]-z[8]*z[178]) - z[6]*(z[7]*z[232]-z[8]*
  z[229]);
  z[276] = -z[33]*z[272] - z[34]*z[273] - z[35]*z[274] - z[36]*z[275] - z[83]*
  z[188] - z[88]*z[187] - z[93]*z[185] - z[96]*z[181];
  z[277] = z[20]*z[232] + z[90]*z[180] - z[6]*z[183] - z[21]*z[229] - z[89]*
  z[178];
  z[278] = z[24]*z[232] + z[25]*z[229] + z[51]*z[180] + z[4]*z[5]*z[18] + 
  z[8]*z[4]*z[5]*z[30] - z[3]*z[19] - z[4]*z[173] - z[12]*z[183] - z[52]*
  z[178] - z[60]*z[174] - z[64]*z[177] - z[7]*z[4]*z[5]*z[31];
  z[279] = (2*z[98]*z[189]*(z[34]*z[38]-z[36]*z[37])-z[39]*(z[276]*(z[34]*
  z[38]-z[36]*z[37])-z[98]*(z[36]*z[186]+z[37]*z[185]-z[34]*z[184]-z[38]*
  z[181])-z[189]*(z[36]*z[92]+z[37]*z[88]-z[34]*z[86]-z[38]*z[83])-z[39]*(
  z[34]*z[278]+z[38]*z[274]+z[83]*z[184]+z[86]*z[181]-z[36]*z[277]-z[37]*
  z[272]-z[88]*z[186]-z[92]*z[185])))/pow(z[39],3);
  z[280] = (2*z[98]*z[189]*(z[33]*z[38]+z[35]*z[37])-z[39]*(z[276]*(z[33]*
  z[38]+z[35]*z[37])+z[98]*(z[33]*z[184]+z[35]*z[186]+z[37]*z[188]+z[38]*
  z[187])+z[189]*(z[33]*z[86]+z[35]*z[92]+z[37]*z[96]+z[38]*z[93])-z[39]*(
  z[33]*z[278]+z[35]*z[277]+z[37]*z[273]+z[38]*z[275]+z[86]*z[187]+z[92]*
  z[188]+z[93]*z[184]+z[96]*z[186])))/pow(z[39],3);
  z[281] = -z[7]*z[279] - z[8]*z[280];
  z[282] = w3*(z[114]*z[235]+z[5]*z[113]*z[190]+z[271]*q2p+z[281]*q3p);
  z[283] = z[7]*z[260] - z[8]*z[190];
  z[284] = z[8]*z[269] - z[7]*z[270];
  z[285] = z[8]*z[279] - z[7]*z[280];
  z[286] = w3*(z[118]*z[235]+z[5]*z[117]*z[190]+z[284]*q2p+z[285]*q3p);
  z[287] = z[41]*z[173] - z[183] - z[19]*z[260];
  z[288] = z[19]*z[270] + z[41]*z[222] + z[50]*z[260] - z[220] - z[103]*
  z[173];
  z[289] = z[17]*z[260] + z[19]*z[280] - z[41]*z[172] - z[104]*z[173];
  z[290] = z[172] + z[19]*z[190] - z[40]*z[173];
  z[291] = z[18]*z[190] + z[41]*z[172] - z[17]*z[260] - z[40]*z[183];
  z[292] = w3*(w3*z[290]+w3*z[41]*z[291]-z[127]*z[235]-w3*z[77]*z[260]-z[5]*
  z[126]*z[190]-z[288]*q2p-z[289]*q3p);
  z[293] = z[173] + z[40]*z[172] + z[100]*z[173] - z[17]*z[190] - z[19]*
  z[279];
  z[294] = z[221] + z[99]*z[173] - z[19]*z[269] - z[40]*z[222] - z[50]*z[190];
  z[295] = w3*(w3*z[77]*z[190]-w3*z[287]-z[130]*z[235]-w3*z[40]*z[291]-z[5]*
  z[131]*z[190]-z[293]*q3p-z[294]*q2p);
  z[296] = z[17]*z[270] + z[41]*z[221] + z[47]*z[260] + z[49]*z[190] + z[99]*
  z[183] - z[18]*z[269] - z[40]*z[220] - z[103]*z[172];
  z[297] = z[17]*z[280] + z[41]*z[173] + z[100]*z[183] - z[18]*z[279] - z[19]*
  z[260] - z[104]*z[172];
  z[298] = w3*(w3*z[40]*z[290]+w3*z[75]*z[260]-z[135]*z[235]-w3*z[41]*z[287]-
  w3*z[76]*z[190]-z[5]*z[134]*z[190]-z[296]*q2p-z[297]*q3p);
  z[299] = -z[180] - z[32]*z[283] - z[74]*z[176];
  z[300] = z[30]*z[283] + z[31]*z[261] + z[73]*z[180] + z[74]*z[178];
  z[301] = z[65]*z[283] - z[215] - z[32]*z[284] - z[74]*z[213] - z[115]*
  z[176];
  z[302] = z[232] + z[66]*z[283] + z[74]*z[230] - z[32]*z[285] - z[116]*
  z[176];
  z[303] = z[32]*z[261] + z[73]*z[176] - z[178];
  z[304] = w3*(w3*z[303]-z[145]*z[235]-w3*z[74]*z[300]-w3*z[80]*z[283]-z[5]*
  z[144]*z[190]-z[301]*q2p-z[302]*q3p);
  z[305] = z[32]*z[271] + z[73]*z[213] + z[111]*z[176] - z[224] - z[65]*
  z[261];
  z[306] = z[229] + z[32]*z[281] + z[112]*z[176] - z[66]*z[261] - z[73]*
  z[230];
  z[307] = w3*(w3*z[73]*z[300]+w3*z[80]*z[261]-w3*z[299]-z[149]*z[235]-z[5]*
  z[148]*z[190]-z[305]*q2p-z[306]*q3p);
  z[308] = z[30]*z[284] + z[31]*z[271] + z[59]*z[283] + z[63]*z[261] + z[73]*
  z[215] + z[74]*z[224] + z[111]*z[180] + z[115]*z[178];
  z[309] = z[30]*z[285] + z[31]*z[281] + z[60]*z[283] + z[64]*z[261] + z[112]*
  z[180] + z[116]*z[178] - z[73]*z[232] - z[74]*z[229];
  z[310] = w3*(w3*z[74]*z[299]+w3*z[78]*z[283]-z[153]*z[235]-w3*z[73]*z[303]-
  w3*z[79]*z[261]-z[5]*z[152]*z[190]-z[308]*q2p-z[309]*q3p);
  z[311] = w3*(z[102]*z[235]+z[5]*z[101]*z[190]-z[269]*q2p-z[279]*q3p);
  z[312] = w3*(z[106]*z[235]+z[5]*z[105]*z[190]-z[270]*q2p-z[280]*q3p);
  z[313] = Ia*z[190]*z[107] + Ib*z[73]*z[282] + Ib*z[261]*z[119] + Ja*z[260]*
  z[108] + Jb*z[74]*z[286] + Jb*z[283]*z[120] - g*(mb*(z[12]*z[300]+z[24]*
  z[299]+z[25]*z[303]+z[78]*z[177]+z[79]*z[174]-z[4]*z[5]*z[80])-ma*(z[11]*
  z[287]+z[4]*z[5]*z[77]-z[3]*z[76]-z[4]*z[290]-z[12]*z[291]-z[4]*z[6]*z[75])) - 
  Ia*z[40]*z[311] - Ja*z[41]*z[312] - ma*(z[75]*z[292]+z[76]*z[295]+z[77]*
  z[298]-z[287]*z[136]-z[290]*z[137]-z[291]*z[138]) - mb*(z[78]*z[304]+z[79]*
  z[307]+z[80]*z[310]-z[299]*z[154]-z[300]*z[156]-z[303]*z[155]);
  z[314] = 2*Ia*z[40]*z[190] + 2*Ja*z[41]*z[260] - 2*Ib*z[73]*z[261] - 2*Jb*
  z[74]*z[283] - 2*ma*(z[75]*z[287]+z[76]*z[290]+z[77]*z[291]) - 2*mb*(z[78]*
  z[299]+z[79]*z[303]+z[80]*z[300]);
  z[315] = (z[158]*z[313]-z[314]*z[159])/pow(z[158],2);
  z[316] = (z[205]*(z[33]*z[38]+z[35]*z[37])-z[39]*(z[33]*z[200]+z[35]*z[202]+
  z[37]*z[204]+z[38]*z[203]))/pow(z[39],2);
  z[317] = z[7]*z[206] + z[8]*z[316];
  z[318] = z[10]*z[192] + z[9]*(z[193]-z[195]) + z[3]*z[6]*(z[7]*z[59]+z[8]*
  z[63]) + z[12]*(z[7]*z[244]-z[8]*z[241]) - z[12]*z[242] - z[3]*z[6]*z[47] - 
  z[4]*z[6]*z[17] - z[11]*(z[239]+z[243]) - z[3]*z[5]*(z[50]-z[65]) - z[4]*
  z[5]*(l+z[19]-z[32]) - z[4]*z[6]*(z[7]*z[30]+z[8]*z[31]) - z[10]*(z[7]*
  z[196]-z[8]*z[198]);
  z[319] = z[4]*z[6]*z[18] + z[10]*(z[7]*z[198]+z[8]*z[196]) + z[3]*z[6]*(
  z[7]*z[63]-z[8]*z[59]) - z[3]*z[6]*z[49] - z[4]*(z[239]+z[243]) - z[3]*(
  z[193]-z[195]) - z[12]*(z[7]*z[241]+z[8]*z[244]) - z[4]*z[6]*(z[7]*z[31]-
  z[8]*z[30]);
  z[320] = z[5]*z[47] + z[5]*(z[239]+z[243]) + z[6]*(z[7]*z[244]-z[8]*z[241]) - 
  z[6]*z[242] - z[6]*(z[50]-z[65]) - z[5]*(z[7]*z[59]+z[8]*z[63]);
  z[321] = z[6]*(z[7]*z[241]+z[8]*z[244]) + z[5]*(z[7]*z[63]-z[49]-z[8]*z[59]);
  z[322] = -z[33]*z[318] - z[34]*z[319] - z[35]*z[320] - z[36]*z[321] - z[84]*
  z[204] - z[87]*z[203] - z[94]*z[201] - z[95]*z[199];
  z[323] = z[7]*z[6]*z[63] - z[6]*z[49] - z[20]*z[241] - z[21]*z[244] - z[8]*
  z[6]*z[59];
  z[324] = z[23]*z[196] + z[25]*z[244] + z[4]*z[5]*z[18] + z[7]*z[3]*z[5]*
  z[63] + z[8]*z[4]*z[5]*z[30] - z[3]*z[192] - z[4]*z[242] - z[22]*z[198] - 
  z[24]*z[241] - z[3]*z[5]*z[49] - z[7]*z[4]*z[5]*z[31] - z[8]*z[3]*z[5]*
  z[59];
  z[325] = (2*z[97]*z[205]*(z[34]*z[38]-z[36]*z[37])-z[39]*(z[322]*(z[34]*
  z[38]-z[36]*z[37])-z[97]*(z[36]*z[202]+z[37]*z[201]-z[34]*z[200]-z[38]*
  z[199])-z[205]*(z[36]*z[91]+z[37]*z[87]-z[34]*z[85]-z[38]*z[84])-z[39]*(
  z[34]*z[324]+z[38]*z[320]+z[84]*z[200]+z[85]*z[199]-z[36]*z[323]-z[37]*
  z[318]-z[87]*z[202]-z[91]*z[201])))/pow(z[39],3);
  z[326] = (2*z[97]*z[205]*(z[33]*z[38]+z[35]*z[37])-z[39]*(z[322]*(z[33]*
  z[38]+z[35]*z[37])+z[97]*(z[33]*z[200]+z[35]*z[202]+z[37]*z[204]+z[38]*
  z[203])+z[205]*(z[33]*z[85]+z[35]*z[91]+z[37]*z[95]+z[38]*z[94])-z[39]*(
  z[33]*z[324]+z[35]*z[323]+z[37]*z[319]+z[38]*z[321]+z[85]*z[203]+z[91]*
  z[204]+z[94]*z[200]+z[95]*z[202])))/pow(z[39],3);
  z[327] = -z[7]*z[325] - z[8]*z[326];
  z[328] = z[12]*z[195] + z[3]*z[5]*z[66] + z[3]*z[5]*(z[7]*z[30]+z[8]*z[31]) + 
  z[3]*z[6]*(z[7]*z[60]+z[8]*z[64]) - z[11]*z[250] - z[3]*z[6]*(l-z[32]) - 
  z[12]*(z[7]*z[249]+z[8]*z[252]) - z[11]*(z[7]*z[196]-z[8]*z[198]);
  z[329] = z[11]*(z[7]*z[198]+z[8]*z[196]) + z[3]*z[5]*(z[7]*z[31]-z[8]*z[30]) + 
  z[3]*z[6]*(z[7]*z[64]-z[8]*z[60]) - z[3]*z[5]*z[18] - z[4]*(z[192]+z[250]) - 
  z[12]*(z[7]*z[252]-z[8]*z[249]);
  z[330] = z[5]*z[250] + z[6]*z[66] + z[6]*z[195] + z[5]*(l-z[32]) + z[6]*(
  z[7]*z[30]+z[8]*z[31]) + z[5]*(z[7]*z[196]-z[8]*z[198]) - z[5]*(z[7]*z[60]+
  z[8]*z[64]) - z[6]*(z[7]*z[249]+z[8]*z[252]);
  z[331] = z[5]*(z[7]*z[198]+z[8]*z[196]) + z[5]*(z[7]*z[64]-z[8]*z[60]) + 
  z[6]*(z[7]*z[252]-z[8]*z[249]) - z[6]*(z[7]*z[31]-z[18]-z[8]*z[30]);
  z[332] = -z[33]*z[328] - z[34]*z[329] - z[35]*z[330] - z[36]*z[331] - z[83]*
  z[204] - z[88]*z[203] - z[93]*z[201] - z[96]*z[199];
  z[333] = z[21]*z[249] + z[89]*z[196] + z[90]*z[198] + z[7]*z[5]*z[31] + 
  z[7]*z[6]*z[64] - z[5]*z[18] - z[20]*z[252] - z[8]*z[5]*z[30] - z[8]*z[6]*
  z[60];
  z[334] = z[4]*z[193] + z[51]*z[198] + z[52]*z[196] + z[3]*z[6]*z[18] + z[7]*
  z[3]*z[5]*z[64] + z[8]*z[3]*z[6]*z[30] - z[24]*z[252] - z[25]*z[249] - z[7]*
  z[3]*z[6]*z[31] - z[8]*z[3]*z[5]*z[60];
  z[335] = (2*z[98]*z[205]*(z[34]*z[38]-z[36]*z[37])-z[39]*(z[332]*(z[34]*
  z[38]-z[36]*z[37])-z[98]*(z[36]*z[202]+z[37]*z[201]-z[34]*z[200]-z[38]*
  z[199])-z[205]*(z[36]*z[92]+z[37]*z[88]-z[34]*z[86]-z[38]*z[83])-z[39]*(
  z[34]*z[334]+z[38]*z[330]+z[83]*z[200]+z[86]*z[199]-z[36]*z[333]-z[37]*
  z[328]-z[88]*z[202]-z[92]*z[201])))/pow(z[39],3);
  z[336] = (2*z[98]*z[205]*(z[33]*z[38]+z[35]*z[37])-z[39]*(z[332]*(z[33]*
  z[38]+z[35]*z[37])+z[98]*(z[33]*z[200]+z[35]*z[202]+z[37]*z[204]+z[38]*
  z[203])+z[205]*(z[33]*z[86]+z[35]*z[92]+z[37]*z[96]+z[38]*z[93])-z[39]*(
  z[33]*z[334]+z[35]*z[333]+z[37]*z[329]+z[38]*z[331]+z[86]*z[203]+z[92]*
  z[204]+z[93]*z[200]+z[96]*z[202])))/pow(z[39],3);
  z[337] = -z[7]*z[335] - z[8]*z[336];
  z[338] = w3*(z[113]*z[208]+z[114]*z[255]+z[327]*q2p+z[337]*q3p);
  z[339] = z[7]*z[316] - z[8]*z[206];
  z[340] = z[8]*z[325] - z[7]*z[326];
  z[341] = z[8]*z[335] - z[7]*z[336];
  z[342] = w3*(z[117]*z[208]+z[118]*z[255]+z[340]*q2p+z[341]*q3p);
  z[343] = -z[19]*z[316] - z[41]*z[193];
  z[344] = z[19]*z[326] + z[50]*z[316] + z[103]*z[193] - z[41]*z[243];
  z[345] = z[17]*z[316] + z[19]*z[336] + z[104]*z[193] - z[41]*z[192];
  z[346] = z[192] + z[19]*z[206] + z[40]*z[193];
  z[347] = z[18]*z[206] + z[41]*z[192] - z[17]*z[316];
  z[348] = w3*(w3*z[346]+w3*z[41]*z[347]-z[126]*z[208]-z[127]*z[255]-w3*z[77]*
  z[316]-z[344]*q2p-z[345]*q3p);
  z[349] = z[40]*z[192] - z[193] - z[17]*z[206] - z[19]*z[335] - z[100]*
  z[193];
  z[350] = z[242] + z[40]*z[243] - z[19]*z[325] - z[50]*z[206] - z[99]*z[193];
  z[351] = w3*(w3*z[77]*z[206]-w3*z[343]-z[130]*z[255]-z[131]*z[208]-w3*z[40]*
  z[347]-z[349]*q3p-z[350]*q2p);
  z[352] = z[17]*z[326] + z[41]*z[242] + z[47]*z[316] + z[49]*z[206] - z[18]*
  z[325] - z[103]*z[192];
  z[353] = z[17]*z[336] - z[18]*z[335] - z[19]*z[316] - z[41]*z[193] - z[104]*
  z[192];
  z[354] = w3*(w3*z[40]*z[346]+w3*z[75]*z[316]-z[134]*z[208]-z[135]*z[255]-w3*
  z[41]*z[343]-w3*z[76]*z[206]-z[352]*q2p-z[353]*q3p);
  z[355] = z[74]*z[195] - z[198] - z[32]*z[339];
  z[356] = z[30]*z[339] + z[31]*z[317] + z[73]*z[198] - z[74]*z[196];
  z[357] = z[65]*z[339] + z[115]*z[195] - z[241] - z[32]*z[340] - z[74]*
  z[239];
  z[358] = z[66]*z[339] + z[116]*z[195] - z[252] - z[32]*z[341] - z[74]*
  z[250];
  z[359] = z[196] + z[32]*z[317] - z[73]*z[195];
  z[360] = w3*(w3*z[359]-z[144]*z[208]-z[145]*z[255]-w3*z[74]*z[356]-w3*z[80]*
  z[339]-z[357]*q2p-z[358]*q3p);
  z[361] = z[244] + z[32]*z[327] + z[73]*z[239] - z[65]*z[317] - z[111]*
  z[195];
  z[362] = z[32]*z[337] + z[73]*z[250] - z[249] - z[66]*z[317] - z[112]*
  z[195];
  z[363] = w3*(w3*z[73]*z[356]+w3*z[80]*z[317]-w3*z[355]-z[148]*z[208]-z[149]*
  z[255]-z[361]*q2p-z[362]*q3p);
  z[364] = z[30]*z[340] + z[31]*z[327] + z[59]*z[339] + z[63]*z[317] + z[73]*
  z[241] + z[111]*z[198] - z[74]*z[244] - z[115]*z[196];
  z[365] = z[30]*z[341] + z[31]*z[337] + z[60]*z[339] + z[64]*z[317] + z[73]*
  z[252] + z[74]*z[249] + z[112]*z[198] - z[116]*z[196];
  z[366] = w3*(w3*z[74]*z[355]+w3*z[78]*z[339]-z[152]*z[208]-z[153]*z[255]-w3*
  z[73]*z[359]-w3*z[79]*z[317]-z[364]*q2p-z[365]*q3p);
  z[367] = w3*(z[101]*z[208]+z[102]*z[255]-z[325]*q2p-z[335]*q3p);
  z[368] = w3*(z[105]*z[208]+z[106]*z[255]-z[326]*q2p-z[336]*q3p);
  z[369] = Ia*z[206]*z[107] + Ib*z[73]*z[338] + Ib*z[317]*z[119] + Ja*z[316]*
  z[108] + Jb*z[74]*z[342] + Jb*z[339]*z[120] - g*(ma*(z[4]*z[346]+z[12]*
  z[347]-z[11]*z[343]-z[3]*z[5]*z[75]-z[3]*z[6]*z[77])-mb*(z[3]*z[6]*z[80]+
  z[7]*z[3]*z[5]*z[78]-z[12]*z[356]-z[24]*z[355]-z[25]*z[359]-z[8]*z[3]*z[5]*
  z[79])) - Ia*z[40]*z[367] - Ja*z[41]*z[368] - ma*(z[75]*z[348]+z[76]*z[351]+
  z[77]*z[354]-z[343]*z[136]-z[346]*z[137]-z[347]*z[138]) - mb*(z[78]*z[360]+
  z[79]*z[363]+z[80]*z[366]-z[355]*z[154]-z[356]*z[156]-z[359]*z[155]);
  z[370] = 2*Ia*z[40]*z[206] + 2*Ja*z[41]*z[316] - 2*Ib*z[73]*z[317] - 2*Jb*
  z[74]*z[339] - 2*ma*(z[75]*z[343]+z[76]*z[346]+z[77]*z[347]) - 2*mb*(z[78]*
  z[355]+z[79]*z[359]+z[80]*z[356]);
  z[371] = (z[158]*z[369]-z[370]*z[159])/pow(z[158],2);
  z[372] = z[43]*z[113] + z[70]*z[114] + z[111]*q2p + z[112]*q3p;
  z[373] = z[43]*z[117] + z[70]*z[118] + z[115]*q2p + z[116]*q3p;
  z[374] = z[43]*z[126] + z[70]*z[127] + z[124]*q2p + z[125]*q3p - 2*w3*z[76] - 
  2*w3*z[41]*z[77];
  z[375] = z[43]*z[131] + z[70]*z[130] + 2*w3*z[75] + 2*w3*z[40]*z[77] + 
  z[128]*q3p + z[129]*q2p;
  z[376] = z[43]*z[134] + z[70]*z[135] + 2*w3*z[41]*z[75] + z[132]*q2p + 
  z[133]*q3p - 2*w3*z[40]*z[76];
  z[377] = z[43]*z[144] + z[70]*z[145] + 2*w3*z[74]*z[80] + z[142]*q2p + 
  z[143]*q3p - 2*w3*z[79];
  z[378] = z[43]*z[148] + z[70]*z[149] + 2*w3*z[78] + z[146]*q2p + z[147]*q3p - 
  2*w3*z[73]*z[80];
  z[379] = z[43]*z[152] + z[70]*z[153] + 2*w3*z[73]*z[79] + z[150]*q2p + 
  z[151]*q3p - 2*w3*z[74]*z[78];
  z[380] = z[43]*z[101] + z[70]*z[102] + z[99]*q2p + z[100]*q3p;
  z[381] = z[43]*z[105] + z[70]*z[106] + z[103]*q2p + z[104]*q3p;
  z[382] = Ib*z[73]*z[372] + Jb*z[74]*z[373] + ma*(z[75]*z[374]+z[76]*z[375]+
  z[77]*z[376]) + mb*(z[78]*z[377]+z[79]*z[378]+z[80]*z[379]) - Ia*z[40]*
  z[380] - Ja*z[41]*z[381];

  p->A[1] = -w3*z[191];
  p->A[2] = w3*z[207];
  p->A[5] = z[42];
  p->A[7] = w3*z[5]*z[190];
  p->A[8] = w3*z[208];
  p->A[11] = z[43];
  p->A[13] = w3*z[235];
  p->A[14] = w3*z[255];
  p->A[17] = z[70];
  p->A[18] = w3*z[72];
  p->A[19] = -w3*z[256];
  p->A[20] = -w3*z[257];
  p->A[23] = -z[71];
  p->A[24] = -w3*z[71];
  p->A[25] = -w3*z[258];
  p->A[26] = -w3*z[259];
  p->A[28] = -z[72];
  p->A[31] = z[315];
  p->A[32] = z[371];
  p->A[35] = z[382]/z[158];
  p->no_cb[0] = q4 + z[17]*z[161] + z[30]*z[167] + z[32]*z[163] - z[18]*z[162] - 
  z[31]*z[168] - z[163]*(l+z[19]);
  p->no_cb[1] = q5 + z[17]*z[164] + z[18]*z[165] + z[30]*z[169] + z[32]*z[166] - 
  z[31]*z[170] - z[166]*(l+z[19]);
  p->no_cb[2] = z[4]*z[18] + z[12]*z[32] + z[24]*z[30] - z[11]*z[17] - z[25]*
  z[31] - z[12]*(l+z[19]);
  p->T_da[0] = z[161];
  p->T_da[1] = z[164];
  p->T_da[2] = -z[11];
  p->T_da[4] = -z[162];
  p->T_da[5] = z[165];
  p->T_da[6] = z[4];
  p->T_da[8] = z[163];
  p->T_da[9] = z[166];
  p->T_da[10] = z[12];
  p->T_da[12] = q4 + z[17]*z[161] - z[18]*z[162] - z[19]*z[163];
  p->T_da[13] = q5 + z[17]*z[164] + z[18]*z[165] - z[19]*z[166];
  p->T_da[14] = z[4]*z[18] - z[11]*z[17] - z[12]*z[19];
  p->T_db[0] = z[167];
  p->T_db[1] = z[169];
  p->T_db[2] = z[24];
  p->T_db[4] = z[168];
  p->T_db[5] = z[170];
  p->T_db[6] = z[25];
  p->T_db[8] = z[163];
  p->T_db[9] = z[166];
  p->T_db[10] = z[12];
  p->T_db[12] = q4 + z[17]*z[161] - z[18]*z[162] - z[163]*(l+z[19]);
  p->T_db[13] = q5 + z[17]*z[164] + z[18]*z[165] - z[166]*(l+z[19]);
  p->T_db[14] = z[4]*z[18] - z[11]*z[17] - z[12]*(l+z[19]);
  
} // sdOutputs()

void sdPrint(sd_t * p)
{
  int i;
  printf("%5.2f", p->t);
  for (i = 0; i < 6; ++i)
    printf("%12.7f", p->x[i]);
  printf("%12.7f%12.7f%12.7f", p->no_cb[0], p->no_cb[1], p->no_cb[2]);
  printf("%12.7f%12.7f%12.7f", p->ke, p->pe, p->ke + p->pe);
  printf("\n");
} // sdPrint()

void sdPrintf(sd_t * p)
{
  int i;
  for (i = 0; i < 5; ++i)
    printf("%12.7f", p->f[i]);
  printf("\n");
} // sdPrintf()

void sdWriteRecord(sd_t * p, FILE * fp)
{
  fwrite(&(p->t), sizeof(double), 1, fp);
  fwrite(p->x, sizeof(double), 6, fp);
  fwrite(p->no_cb, sizeof(double), 3, fp);
  fwrite(&(p->T_da[12]), sizeof(double), 3, fp);
  fwrite(&(p->T_db[12]), sizeof(double), 3, fp);
  fwrite(&(p->ke), sizeof(double), 1, fp);
  fwrite(&(p->pe), sizeof(double), 1, fp);
  double te = p->ke + p->pe;
  fwrite(&te, sizeof(double), 1, fp);
} // sdWriteRecord()
