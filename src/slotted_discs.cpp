#include "slotted_discs.h"

int eomwrapper(double t, const double x[6], double f[6], void * params)
{
  SlottedDiscs * p = (SlottedDiscs *) params;
  // Assign the states of the SlottedDiscs object
  p->setState(x);
  // Evaluate the RHS of the ODE's representing the equations of motion
  p->eoms();
  // Assign the right hand sides of the ODE's to the array passed
  f[0] = p->q1p;
  f[1] = p->q2p;
  f[2] = p->q3p;
  f[3] = p->q4p;
  f[4] = p->q5p;
  f[5] = p->wp;
  // Return the status
  return GSL_SUCCESS;
} // eomwrapper()

double hc(double q3, void * params)
{
  SlottedDiscs * p = (SlottedDiscs *) params;
  p->q3 = q3;
  return p->hc();
} // hc

double hc_deriv(double q3, void * params)
{
  SlottedDiscs * p = (SlottedDiscs *) params;
  p->q3 = q3;
  return p->hc_deriv();
}

ostream &operator<<(ostream &file, const SlottedDiscs * discs)
{
  file.write((char *) &(discs->t), sizeof discs->t);
  file.write((char *) &discs->q1, sizeof discs->q1);
  file.write((char *) &discs->q2, sizeof discs->q2);
  file.write((char *) &discs->q3, sizeof discs->q3);
  file.write((char *) &discs->q4, sizeof discs->q4);
  file.write((char *) &discs->q5, sizeof discs->q5);
  file.write((char *) &discs->q1p, sizeof discs->q1p);
  file.write((char *) &discs->q2p, sizeof discs->q2p);
  file.write((char *) &discs->q3p, sizeof discs->q3p);
  file.write((char *) &discs->q4p, sizeof discs->q4p);
  file.write((char *) &discs->q5p, sizeof discs->q5p);
  file.write((char *) &discs->w, sizeof discs->w);
  file.write((char *) &discs->w1, sizeof discs->w1);
  file.write((char *) &discs->w2, sizeof discs->w2);
  file.write((char *) &discs->w3, sizeof discs->w3);
  file.write((char *) &(discs->no_cb), sizeof discs->no_cb);
  file.write((char *) &(discs->no_so), sizeof discs->no_so);
  file.write((char *) &(discs->ke), sizeof discs->ke);
  file.write((char *) &(discs->pe), sizeof discs->pe);
  file.write((char *) &(discs->te), sizeof discs->te);
  file.write((char *) &(discs->H), sizeof discs->H);
  file.write((char *) &(discs->p), sizeof discs->p);
  file.write((char *) &(discs->fx), sizeof discs->fx);
  file.write((char *) &(discs->fay), sizeof discs->fay);
  file.write((char *) &(discs->faz), sizeof discs->faz);
  file.write((char *) &(discs->fby), sizeof discs->fby);
  file.write((char *) &(discs->fbz), sizeof discs->fbz);
  file.write((char *) &(discs->a_so), sizeof discs->a_so);
  return file;
} // operator <<

void setParams(DiscParams * p, double ma, double mb, double ra, double rb, double l, double alpha, double g) 
{
  double Ia = ma*ra*ra/4.0;
  double Ja = ma*ra*ra/2.0;
  double Ib = mb*rb*rb/4.0;
  double Jb = mb*rb*rb/2.0;
  p->m = ma + mb;
  p->ra = ra;
  p->rb = rb;
  p->l = l;
  p->g = 9.81;
  p->alpha = alpha;
  p->k = l*mb/(ma+mb);
  p->Ixx = Ia + Ib*pow(cos(alpha),2) + Jb*pow(sin(alpha),2) + mb*pow(l,2)*(ma*mb/
  pow((ma+mb),2)+pow((1-mb/(ma+mb)),2));
  p->Iyy = Ja + Jb + pow(sin(alpha),2)*(Ib-Jb) + mb*pow(l,2)*(ma*mb/pow((ma+mb),
  2)+pow((1-mb/(ma+mb)),2));
  p->Izz = Ia + Ib + mb*pow(l,2)*pow((1-mb/(ma+mb)),2) + mb*pow(l,2)*(-1+mb/(ma+
  mb))*(1-mb/(ma+mb));
  p->Ixy = sin(alpha)*cos(alpha)*(Ib-Jb);
} // setParams

void SlottedDiscs::writeRecord_dt(void) const
{
  ofstream fp("./record.py", ios::out);
  fp << "#!/usr/bin/env python" << endl;
  fp << "import numpy as np" << endl;
  fp << "record_dt = np.dtype([('t', np.float64), " <<
        "('q1', np.float64), " <<
        "('q2', np.float64), " <<
        "('q3', np.float64), " <<
        "('x', np.float64), " <<
        "('y', np.float64), " <<
        "('q1p', np.float64), " <<
        "('q2p', np.float64), " <<
        "('q3p', np.float64), " <<
        "('q4p', np.float64), " <<
        "('q5p', np.float64), " <<
        "('w', np.float64), " <<
        "('w1', np.float64), " <<
        "('w2', np.float64), " <<
        "('w3', np.float64), " <<
        "('cbx', np.float64), " <<
        "('cby', np.float64), " <<
        "('cbz', np.float64), " <<
        "('sox', np.float64), " <<
        "('soy', np.float64), " <<
        "('soz', np.float64), " <<
        "('ke', np.float64), " <<
        "('pe', np.float64), " <<
        "('te', np.float64), " <<
        "('H1', np.float64), " <<
        "('H2', np.float64), " <<
        "('H3', np.float64), " <<
        "('p1', np.float64), " <<
        "('p2', np.float64), " <<
        "('p3', np.float64), " <<
        "('fx', np.float64), " <<
        "('fay', np.float64), " <<
        "('faz', np.float64), " <<
        "('fby', np.float64), " <<
        "('fbz', np.float64), " <<
        "('aso1', np.float64), " <<
        "('aso2', np.float64), " <<
        "('aso3', np.float64)])" <<
        endl;
  fp.close();
} // writeRecord_dt()

SlottedDiscs::SlottedDiscs()
{
  // Default parameters
  DiscParams * p = new DiscParams;
  double ma, mb;
  ma = mb = 2.0;
  ra = rb = .1;
  l = sqrt(2.0)*ra;
  g = 9.81;
  alpha = M_PI/2.0;
  setParams(p, ma, mb, ra, rb, l, alpha, g);
  setParameters(p);
  delete p;

  // Set state
  q1 = 0.0;
  q2 = M_PI/4.0;
  q3 = M_PI/2.0;
  q4 = q5 = 0.0;
  w = 1.0;

  // Set integration settings
  t = 0.0;
  tf = 10.0;
  h = 0.001;
  fps = 1000;
  T = gsl_odeiv_step_rk8pd;
  s = gsl_odeiv_step_alloc(T, 6);
  c = gsl_odeiv_control_y_new(1e-6, 1e-9);
  e = gsl_odeiv_evolve_alloc(6);
  sys.function = eomwrapper;
  sys.jacobian = NULL;
  sys.dimension = 6;
  sys.params = this;

  for (int i = 0; i < Z_MAX; ++i)
    z[i] = 0.0;

  // Camera settings
  theta = M_PI / 4.0;
  phi = 0.0;
  d = 1.0;
  ctx = .35;
  cty = .35; 
  ctz = 0.0;
  
  // Constants
  evalConstants();
  eoms();
  computeOutputs();

  // Write the file which holds the numpy record data type so that plotting is
  // easy
  writeRecord_dt();
 
} // constructor

SlottedDiscs::~SlottedDiscs()
{
  gsl_odeiv_evolve_free(e);
  gsl_odeiv_control_free(c);
  gsl_odeiv_step_free(s);
} // destructor

void SlottedDiscs::printState(void) const
{
  cout.setf(ios::right, ios::adjustfield);
  cout.setf(ios::scientific, ios::floatfield);
  cout.setf(ios::adjustfield, ios::right);
  cout.precision(9);
  cout.width(18);
  cout << q1;
  cout.width(18);
  cout << q2;
  cout.width(18);
  cout << q3;
  cout.width(18);
  cout << q4;
  cout.width(18);
  cout << q5;
  cout.width(18);
  cout << w3;
  cout << endl;
} // printState()

void SlottedDiscs::printEnergy(void) const
{
  cout.setf(ios::scientific, ios::floatfield);
  cout.setf(ios::adjustfield, ios::right);
  cout.precision(9);
  cout.width(18);
  cout << ke;
  cout.width(18);
  cout << pe;
  cout.width(18);
  cout << te;
  cout << endl;
} // printEnergy()

void SlottedDiscs::printParameters() const
{
  cout.setf(ios::scientific, ios::floatfield);
  cout.setf(ios::adjustfield, ios::right);
  cout.precision(9);
  cout << "ra = " << ra << endl << "rb = " << rb << endl;
  cout << "m = " << m << endl;
  cout << "Ixx = " << Ixx << endl << "Iyy = " << Iyy << endl;
  cout << "Izz = " << Izz << endl << "Ixy = " << Ixy << endl;
  cout << "alpha = " << alpha << endl << "l = " << l << endl;
  cout << "k = " << k << endl;
  cout << "g = " << g << endl;
} // printParameters()

void SlottedDiscs::evalConstants(void)
{
  z[118] = g*m;
  z[1] = cos(phi);
  z[2] = sin(phi);
  z[3] = sin(theta);
  z[4] = z[2]*z[3];
  z[5] = z[1]*z[3];
  z[6] = cos(theta);
  z[7] = z[2]*z[6];
  z[8] = z[1]*z[6];
  z[15] = cos(alpha);
  z[16] = sin(alpha);
  z[48] = rb*z[16];
  z[49] = pow(z[16],2);
  z[172] = pow(z[15],2);
  z[174] = z[16]*z[48];
  z[175] = z[15]*z[16];
  z[273] = m*ra;
} //evalConstants()

void SlottedDiscs::eoms(void)
{
  z[14] = sin(q3);
  z[17] = ra*z[14];
  z[12] = sin(q2);
  z[11] = cos(q2);
  z[21] = z[11]*z[14];
  z[28] = z[15]*z[12] + z[16]*z[21];
  z[29] = 1 - pow(z[28],2);
  z[30] = pow(z[29],0.5);
  z[32] = z[28]/z[30];
  z[31] = 1/z[30];
  z[33] = rb*(z[16]*z[32]-z[21]*z[31]);
  z[36] = z[17] + z[33];
  z[34] = rb*(z[15]*z[32]-z[12]*z[31]);
  z[13] = cos(q3);
  z[22] = z[11]*z[13];
  z[35] = rb*z[22]*z[31];
  z[18] = ra*z[13];
  z[37] = z[35] - l - z[18];
  z[38] = pow(z[34],2) + pow(z[36],2) + pow(z[37],2);
  z[39] = pow(z[38],0.5);
  z[40] = z[36]/z[39];
  w1 = w*z[40];
  z[41] = z[37]/z[39];
  w3 = w*z[41];
  q1p = -(w1*z[14]-w3*z[13])/z[11];
  q2p = w1*z[13] + w3*z[14];
  z[50] = (z[11]*z[34]+rb*z[22]*(z[12]*z[13]*z[31]-z[22]*z[28]*(z[15]*z[11]-
  z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2)))-z[12]*z[14]*(z[17]+z[33])-
  z[12]*z[13]*(l+z[18]-z[35])-rb*z[12]*(z[11]*z[31]+z[12]*z[28]*(z[15]*z[11]-
  z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2))-z[15]*(z[30]+pow(z[28],2)/
  pow(z[29],0.5))*(z[15]*z[11]-z[16]*z[12]*z[14])/pow(z[30],2))-rb*z[21]*(
  z[21]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2))-
  z[12]*z[14]*z[31]-z[16]*(z[30]+pow(z[28],2)/pow(z[29],0.5))*(z[15]*z[11]-
  z[16]*z[12]*z[14])/pow(z[30],2)))*q2p/(z[11]*z[14]*(l+z[18]-z[35])+z[48]*
  z[11]*z[12]*z[13]*(z[12]*z[28]/pow(z[29],0.5)-z[15]*(z[30]+pow(z[28],2)/
  pow(z[29],0.5)))/pow(z[30],2)-z[11]*z[13]*(z[17]+z[33])-z[22]*(rb*z[11]*
  z[14]*z[31]-ra*z[14]-z[48]*z[11]*z[13]*z[22]*z[28]/(pow(z[29],0.5)*pow(
  z[30],2)))-z[13]*z[21]*(ra-rb*z[11]*(z[31]+z[16]*z[21]*z[28]/(pow(z[29],0.5)*
  pow(z[30],2))-z[49]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2))));
  q3p = z[50];
  z[9] = cos(q1);
  z[10] = sin(q1);
  z[20] = z[12]*z[13];
  z[55] = z[9]*z[14] + z[10]*z[20];
  z[19] = z[12]*z[14];
  z[51] = z[9]*z[13] - z[10]*z[19];
  z[57] = (z[17]*z[55]+z[18]*z[51])*q3p;
  q4p = -z[57];
  z[56] = z[10]*z[14] - z[9]*z[20];
  z[52] = z[9]*z[19] + z[10]*z[13];
  z[58] = (z[17]*z[56]+z[18]*z[52])*q3p;
  q5p = -z[58];
  z[42] = z[34]/z[39];
  z[26] = z[15]*z[11] - z[16]*z[19];
  z[64] = z[26]*z[28];
  z[66] = z[64]/pow(z[29],0.5);
  z[68] = (z[26]*z[30]+z[28]*z[66])/pow(z[30],2);
  z[70] = z[66]/pow(z[30],2);
  z[75] = rb*(z[15]*z[68]-z[11]*z[31]-z[12]*z[70]);
  z[72] = rb*(z[16]*z[68]+z[19]*z[31]-z[21]*z[70]);
  z[77] = rb*(z[20]*z[31]-z[22]*z[70]);
  z[80] = 2*z[34]*z[75] + 2*z[36]*z[72] - 2*z[37]*z[77];
  z[82] = z[80]/pow(z[38],0.5);
  z[92] = (z[37]*z[82]+2*z[39]*z[77])/pow(z[39],2);
  z[94] = w*z[92];
  z[63] = z[16]*z[22];
  z[65] = z[28]*z[63];
  z[67] = z[65]/pow(z[29],0.5);
  z[69] = (z[28]*z[67]+z[30]*z[63])/pow(z[30],2);
  z[71] = z[67]/pow(z[30],2);
  z[76] = rb*(z[15]*z[69]-z[12]*z[71]);
  z[73] = rb*(z[16]*z[69]-z[21]*z[71]-z[22]*z[31]);
  z[74] = z[18] + z[73];
  z[78] = rb*(z[21]*z[31]-z[22]*z[71]);
  z[79] = z[17] - z[78];
  z[81] = 2*z[34]*z[76] + 2*z[36]*z[74] + 2*z[37]*z[79];
  z[83] = z[81]/pow(z[38],0.5);
  z[93] = (z[37]*z[83]-2*z[39]*z[79])/pow(z[39],2);
  z[95] = w*z[93];
  z[98] = -0.5*z[94]*q2p - 0.5*z[95]*q3p;
  z[84] = (z[36]*z[82]-2*z[39]*z[72])/pow(z[39],2);
  z[86] = w*z[84];
  z[85] = (z[36]*z[83]-2*z[39]*z[74])/pow(z[39],2);
  z[87] = w*z[85];
  z[96] = -0.5*z[86]*q2p - 0.5*z[87]*q3p;
  z[88] = (z[34]*z[82]-2*z[39]*z[75])/pow(z[39],2);
  z[90] = w*z[88];
  z[89] = (z[34]*z[83]-2*z[39]*z[76])/pow(z[39],2);
  z[91] = w*z[89];
  z[97] = 0.5*z[90]*q2p + 0.5*z[91]*q3p;
  z[60] = z[17]*z[41] + z[40]*(k+z[18]);
  z[59] = z[42]*(k+z[18]);
  z[110] = z[18]*z[42] - 0.5*z[17]*z[89];
  z[112] = w*z[110];
  z[111] = z[17]*z[88];
  z[113] = w*z[111];
  z[116] = pow(w,2)*z[40]*z[60] + pow(w,2)*z[42]*z[59] + z[112]*q3p - 0.5*
  z[113]*q2p;
  z[102] = -z[17]*z[42] - 0.5*z[89]*(k+z[18]);
  z[104] = w*z[102];
  z[61] = z[17]*z[42];
  z[103] = z[88]*(k+z[18]);
  z[105] = w*z[103];
  z[114] = z[104]*q3p - pow(w,2)*z[41]*z[60] - pow(w,2)*z[42]*z[61] - 0.5*
  z[105]*q2p;
  z[106] = z[18]*z[41] - z[17]*z[40] - 0.5*z[17]*z[93] - 0.5*z[85]*(k+z[18]);
  z[108] = w*z[106];
  z[107] = -0.5*z[17]*z[92] - 0.5*z[84]*(k+z[18]);
  z[109] = w*z[107];
  z[115] = pow(w,2)*z[41]*z[59] + z[108]*q3p + z[109]*q2p - pow(w,2)*z[40]*
  z[61];
  z[119] = z[118]*(z[21]*z[42]*(k+z[18])-z[17]*z[22]*z[42]-z[12]*(z[17]*z[41]+
  z[40]*(k+z[18]))) + Izz*z[41]*z[98] + z[40]*(Ixx*z[96]+Ixy*z[97]) + m*(
  z[17]*z[42]*z[116]+z[42]*(k+z[18])*z[114]+(z[17]*z[41]+z[40]*(k+z[18]))*
  z[115]) - z[42]*(Ixy*z[96]+Iyy*z[97]);
  z[117] = z[42]*(2*Ixy*z[40]-Iyy*z[42]) - Ixx*pow(z[40],2) - Izz*pow(z[41],2) - 
  m*z[17]*z[42]*z[61] - m*z[42]*z[59]*(k+z[18]) - m*z[60]*(z[17]*z[41]+z[40]*(
  k+z[18]));
  z[120] = z[119]/z[117];
  wp = z[120];
} // eoms()

void SlottedDiscs::computeOutputs(void)
{
  fx = m*(z[40]*(z[59]*wp+z[114])+z[41]*(z[61]*wp+z[116])-z[42]*(z[60]*wp+
  z[115]));
  z[122] = m*z[11]*z[13]*z[42]*(z[59]*wp+z[114]) + m*z[11]*z[14]*z[42]*(z[61]*
  wp+z[116]) + m*z[12]*(z[41]+(k+z[18])/pow((pow(z[34],2)+pow(z[36],2)+pow(
  z[37],2)),0.5))*(z[59]*wp+z[114]) + m*(z[21]*z[41]+z[22]*z[40]-(z[17]*z[22]-
  z[21]*(k+z[18]))/pow((pow(z[34],2)+pow(z[36],2)+pow(z[37],2)),0.5))*(z[60]*
  wp+z[115]) - m*z[12]*(z[40]-z[17]/pow((pow(z[34],2)+pow(z[36],2)+pow(z[37],
  2)),0.5))*(z[61]*wp+z[116]) - (z[22]*(pow(w,2)*z[40]*(Ixy*z[40]-Iyy*z[42])+
  pow(w,2)*z[42]*(Ixx*z[40]-Ixy*z[42])+Izz*(z[41]*wp+z[98]))+z[12]*(pow(w,2)*
  z[41]*(Ixx*z[40]-Ixy*z[42])+Ixy*(z[40]*wp+z[96])-Izz*pow(w,2)*z[40]*z[41]-
  Iyy*(z[42]*wp-z[97]))-z[21]*(Ixx*(z[40]*wp+z[96])-Izz*pow(w,2)*z[41]*z[42]-
  pow(w,2)*z[41]*(Ixy*z[40]-Iyy*z[42])-Ixy*(z[42]*wp-z[97])))/pow((pow(z[34],
  2)+pow(z[36],2)+pow(z[37],2)),0.5);
  z[121] = pow(z[11],2)*pow(z[42],2) + pow(z[12],2)*pow(z[40],2) + pow(z[12],
  2)*pow(z[41],2) + pow((z[21]*z[41]+z[22]*z[40]),2) + 2*z[11]*z[12]*z[13]*
  z[41]*z[42] - 2*z[11]*z[12]*z[14]*z[40]*z[42];
  z[126] = z[122]/z[121];
  fay = z[126];
  z[123] = m*z[12]*(z[60]*wp+z[115]) + m*z[22]*(z[61]*wp+z[116]) - z[118] - m*
  z[21]*(z[59]*wp+z[114]) - (z[118]*z[21]*(k+z[18])*(z[21]*z[41]+z[22]*z[40])+
  m*z[17]*(z[21]*z[41]+z[22]*z[40])*(z[61]*wp+z[116])+m*(k+z[18])*(z[21]*
  z[41]+z[22]*z[40])*(z[59]*wp+z[114])+m*(z[12]*z[17]*z[40]-z[12]*z[41]*(k+
  z[18])-z[11]*z[42]*(z[14]*z[17]+z[13]*(k+z[18])))*(z[60]*wp+z[115])+z[12]*
  z[40]*(pow(w,2)*z[40]*(Ixy*z[40]-Iyy*z[42])+pow(w,2)*z[42]*(Ixx*z[40]-Ixy*
  z[42])+Izz*(z[41]*wp+z[98]))-z[118]*z[17]*z[22]*(z[21]*z[41]+z[22]*z[40])-
  z[118]*z[12]*(z[12]*z[17]*z[40]-z[12]*z[41]*(k+z[18])-z[11]*z[42]*(z[14]*
  z[17]+z[13]*(k+z[18])))-z[11]*z[14]*z[42]*(pow(w,2)*z[40]*(Ixy*z[40]-Iyy*
  z[42])+pow(w,2)*z[42]*(Ixx*z[40]-Ixy*z[42])+Izz*(z[41]*wp+z[98]))-z[12]*
  z[41]*(Ixx*(z[40]*wp+z[96])-Izz*pow(w,2)*z[41]*z[42]-pow(w,2)*z[41]*(Ixy*
  z[40]-Iyy*z[42])-Ixy*(z[42]*wp-z[97]))-z[11]*z[13]*z[42]*(Ixx*(z[40]*wp+
  z[96])-Izz*pow(w,2)*z[41]*z[42]-pow(w,2)*z[41]*(Ixy*z[40]-Iyy*z[42])-Ixy*(
  z[42]*wp-z[97]))-(z[21]*z[41]+z[22]*z[40])*(pow(w,2)*z[41]*(Ixx*z[40]-Ixy*
  z[42])+Ixy*(z[40]*wp+z[96])-Izz*pow(w,2)*z[40]*z[41]-Iyy*(z[42]*wp-z[97])))/
  pow((pow(z[34],2)+pow(z[36],2)+pow(z[37],2)),0.5);
  faz = z[123];
  z[124] = (m*(z[17]*z[22]-z[21]*(k+z[18]))*(z[60]*wp+z[115])+z[22]*(pow(w,2)*
  z[40]*(Ixy*z[40]-Iyy*z[42])+pow(w,2)*z[42]*(Ixx*z[40]-Ixy*z[42])+Izz*(z[41]*
  wp+z[98]))+z[12]*(pow(w,2)*z[41]*(Ixx*z[40]-Ixy*z[42])+Ixy*(z[40]*wp+z[96])-
  Izz*pow(w,2)*z[40]*z[41]-Iyy*(z[42]*wp-z[97]))-m*z[12]*z[17]*(z[61]*wp+
  z[116])-m*z[12]*(k+z[18])*(z[59]*wp+z[114])-z[21]*(Ixx*(z[40]*wp+z[96])-Izz*
  pow(w,2)*z[41]*z[42]-pow(w,2)*z[41]*(Ixy*z[40]-Iyy*z[42])-Ixy*(z[42]*wp-
  z[97])))/pow((pow(z[34],2)+pow(z[36],2)+pow(z[37],2)),0.5);
  z[127] = z[124]/z[121];
  fby = z[127];
  z[125] = (z[118]*z[21]*(k+z[18])*(z[21]*z[41]+z[22]*z[40])+m*z[17]*(z[21]*
  z[41]+z[22]*z[40])*(z[61]*wp+z[116])+m*(k+z[18])*(z[21]*z[41]+z[22]*z[40])*(
  z[59]*wp+z[114])+m*(z[12]*z[17]*z[40]-z[12]*z[41]*(k+z[18])-z[11]*z[42]*(
  z[14]*z[17]+z[13]*(k+z[18])))*(z[60]*wp+z[115])+z[12]*z[40]*(pow(w,2)*z[40]*(
  Ixy*z[40]-Iyy*z[42])+pow(w,2)*z[42]*(Ixx*z[40]-Ixy*z[42])+Izz*(z[41]*wp+
  z[98]))-z[118]*z[17]*z[22]*(z[21]*z[41]+z[22]*z[40])-z[118]*z[12]*(z[12]*
  z[17]*z[40]-z[12]*z[41]*(k+z[18])-z[11]*z[42]*(z[14]*z[17]+z[13]*(k+z[18])))-
  z[11]*z[14]*z[42]*(pow(w,2)*z[40]*(Ixy*z[40]-Iyy*z[42])+pow(w,2)*z[42]*(Ixx*
  z[40]-Ixy*z[42])+Izz*(z[41]*wp+z[98]))-z[12]*z[41]*(Ixx*(z[40]*wp+z[96])-
  Izz*pow(w,2)*z[41]*z[42]-pow(w,2)*z[41]*(Ixy*z[40]-Iyy*z[42])-Ixy*(z[42]*wp-
  z[97]))-z[11]*z[13]*z[42]*(Ixx*(z[40]*wp+z[96])-Izz*pow(w,2)*z[41]*z[42]-
  pow(w,2)*z[41]*(Ixy*z[40]-Iyy*z[42])-Ixy*(z[42]*wp-z[97]))-(z[21]*z[41]+
  z[22]*z[40])*(pow(w,2)*z[41]*(Ixx*z[40]-Ixy*z[42])+Ixy*(z[40]*wp+z[96])-Izz*
  pow(w,2)*z[40]*z[41]-Iyy*(z[42]*wp-z[97])))/pow((pow(z[34],2)+pow(z[36],2)+
  pow(z[37],2)),0.5);
  fbz = z[125];
  z[43] = pow(z[33],2) + pow(z[34],2) + pow(z[35],2);
  z[44] = pow(z[43],0.5);
  z[45] = z[33]/z[44];
  z[46] = z[34]/z[44];
  z[47] = z[35]/z[44];
  w2 = -w*z[42];
  z[53] = z[10]*z[11];
  z[54] = z[9]*z[11];
  ke = 0.5*pow(w,2)*(Iyy*pow(z[42],2)+Izz*pow(z[41],2)+z[40]*(Ixx*z[40]-2*Ixy*
  z[42])+m*(pow(z[59],2)+pow(z[60],2)+pow(z[61],2)));
  pe = g*m*(z[17]*z[21]+z[22]*(k+z[18]));
  te = ke + pe;
  z[128] = z[1]*z[51] + z[2]*z[52];
  z[129] = z[2]*z[54] - z[1]*z[53];
  z[130] = z[1]*z[55] + z[2]*z[56];
  z[131] = z[4]*z[51] + z[6]*z[21] - z[5]*z[52];
  z[132] = -z[4]*z[53] - z[5]*z[54] - z[6]*z[12];
  z[133] = z[4]*z[55] - z[5]*z[56] - z[6]*z[22];
  z[134] = z[3]*z[21] + z[8]*z[52] - z[7]*z[51];
  z[135] = z[7]*z[53] + z[8]*z[54] - z[3]*z[12];
  z[136] = z[8]*z[56] - z[3]*z[22] - z[7]*z[55];
  z[137] = z[15]*z[128] + z[16]*z[129];
  z[138] = z[15]*z[129] - z[16]*z[128];
  z[139] = z[15]*z[131] + z[16]*z[132];
  z[140] = z[15]*z[132] - z[16]*z[131];
  z[141] = z[15]*z[134] + z[16]*z[135];
  z[142] = z[15]*z[135] - z[16]*z[134];
  z[143] = z[1]*z[9] + z[2]*z[10];
  z[144] = z[2]*z[9] - z[1]*z[10];
  z[145] = z[4]*z[9] - z[5]*z[10];
  z[146] = -z[4]*z[10] - z[5]*z[9];
  z[147] = z[8]*z[10] - z[7]*z[9];
  z[148] = z[7]*z[10] + z[8]*z[9];
  z[149] = z[15]*z[11] - z[16]*z[12]*z[14];
  z[150] = z[149]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2);
  z[151] = z[28]*z[149]/(pow(z[29],0.5)*pow(z[30],2));
  z[152] = rb*(z[21]*z[151]-z[16]*z[150]-z[12]*z[14]*z[31]);
  z[153] = rb*(z[15]*z[150]-z[11]*z[31]-z[12]*z[151]);
  z[154] = rb*(z[22]*z[151]-z[12]*z[13]*z[31]);
  z[155] = 2*z[34]*z[153] + 2*z[37]*z[154] - 2*z[36]*z[152];
  z[156] = (2*z[39]*z[152]+z[36]*z[155]/pow(z[38],0.5))/pow(z[39],2);
  z[157] = (2*z[39]*z[154]-z[37]*z[155]/pow(z[38],0.5))/pow(z[39],2);
  z[158] = (w*z[11]*(z[13]*z[157]+z[14]*z[156])-2*z[12]*(w1*z[14]-w3*z[13]))/
  pow(z[11],2);
  z[159] = z[16]*z[11]*z[13]*z[28];
  z[160] = (z[16]*z[11]*z[13]*z[30]+z[28]*z[159]/pow(z[29],0.5))/pow(z[30],2);
  z[161] = rb*(z[16]*z[160]-z[11]*z[13]*z[31]-z[21]*z[159]/(pow(z[29],0.5)*
  pow(z[30],2)));
  z[162] = rb*(z[15]*z[160]-z[12]*z[159]/(pow(z[29],0.5)*pow(z[30],2)));
  z[163] = rb*(z[11]*z[14]*z[31]-z[22]*z[159]/(pow(z[29],0.5)*pow(z[30],2)));
  z[164] = 2*z[34]*z[162] + 2*z[36]*(z[161]+ra*z[13]) - 2*z[37]*(z[163]-ra*
  z[14]);
  z[165] = (z[36]*z[164]/pow(z[38],0.5)-2*z[39]*(z[161]+ra*z[13]))/pow(z[39],
  2);
  z[166] = (z[37]*z[164]/pow(z[38],0.5)+2*z[39]*(z[163]-ra*z[14]))/pow(z[39],
  2);
  z[167] = (2*w1*z[13]+2*w3*z[14]+w*z[13]*z[166]-w*z[14]*z[165])/z[11];
  z[168] = (z[13]*z[41]-z[14]*z[40])/z[11];
  z[169] = w*(z[13]*z[156]-z[14]*z[157]);
  z[170] = w3*z[13] - w1*z[14] - 0.5*w*z[13]*z[165] - 0.5*w*z[14]*z[166];
  z[171] = z[13]*z[40] + z[14]*z[41];
  z[173] = (z[169]*(z[11]*z[14]*(l+z[18]-z[35])+z[48]*z[11]*z[12]*z[13]*(
  z[12]*z[28]/pow(z[29],0.5)-z[15]*(z[30]+pow(z[28],2)/pow(z[29],0.5)))/pow(
  z[30],2)-z[11]*z[13]*(z[17]+z[33])-z[22]*(rb*z[11]*z[14]*z[31]-ra*z[14]-
  z[48]*z[11]*z[13]*z[22]*z[28]/(pow(z[29],0.5)*pow(z[30],2)))-z[13]*z[21]*(
  ra-rb*z[11]*(z[31]+z[16]*z[21]*z[28]/(pow(z[29],0.5)*pow(z[30],2))-z[49]*(
  z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2))))*(z[11]*z[34]+rb*z[22]*(
  z[12]*z[13]*z[31]-z[22]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(z[29],
  0.5)*pow(z[30],2)))-z[12]*z[14]*(z[17]+z[33])-z[12]*z[13]*(l+z[18]-z[35])-
  rb*z[12]*(z[11]*z[31]+z[12]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(
  z[29],0.5)*pow(z[30],2))-z[15]*(z[30]+pow(z[28],2)/pow(z[29],0.5))*(z[15]*
  z[11]-z[16]*z[12]*z[14])/pow(z[30],2))-rb*z[21]*(z[21]*z[28]*(z[15]*z[11]-
  z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2))-z[12]*z[14]*z[31]-z[16]*(
  z[30]+pow(z[28],2)/pow(z[29],0.5))*(z[15]*z[11]-z[16]*z[12]*z[14])/pow(
  z[30],2)))+2*(z[11]*z[34]+rb*z[22]*(z[12]*z[13]*z[31]-z[22]*z[28]*(z[15]*
  z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2)))-z[12]*z[14]*(z[17]+
  z[33])-z[12]*z[13]*(l+z[18]-z[35])-rb*z[12]*(z[11]*z[31]+z[12]*z[28]*(z[15]*
  z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2))-z[15]*(z[30]+pow(
  z[28],2)/pow(z[29],0.5))*(z[15]*z[11]-z[16]*z[12]*z[14])/pow(z[30],2))-rb*
  z[21]*(z[21]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(
  z[30],2))-z[12]*z[14]*z[31]-z[16]*(z[30]+pow(z[28],2)/pow(z[29],0.5))*(
  z[15]*z[11]-z[16]*z[12]*z[14])/pow(z[30],2)))*(z[11]*z[13]*z[152]+z[12]*
  z[13]*(z[17]+z[33])+2*z[48]*z[11]*z[12]*z[13]*z[149]*pow(z[28],2)*(z[12]-
  z[15]*z[28])/(z[29]*pow(z[30],3))+z[48]*z[11]*z[12]*z[13]*z[149]*(z[12]*
  z[29]+z[12]*pow(z[28],2)-z[15]*z[28]*(3*z[29]+pow(z[28],2)))/(pow(z[29],1.5)*
  pow(z[30],2))-z[11]*z[14]*z[154]-z[12]*z[14]*(l+z[18]-z[35])-2*z[48]*z[11]*
  z[12]*z[22]*z[28]*pow(z[13],2)/(pow(z[29],0.5)*pow(z[30],2))-rb*z[11]*z[12]*
  z[13]*z[14]*(2*z[16]*z[21]*z[28]/(pow(z[29],0.5)*pow(z[30],2))-z[49]*(z[30]+
  pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2))-z[48]*z[13]*(pow(z[12],2)*(z[12]*
  z[28]/pow(z[29],0.5)-z[15]*(z[30]+pow(z[28],2)/pow(z[29],0.5)))-pow(z[11],2)*(
  2*z[12]*z[28]/pow(z[29],0.5)-z[15]*(z[30]+pow(z[28],2)/pow(z[29],0.5))))/
  pow(z[30],2)-z[22]*(rb*z[11]*z[14]*z[151]-rb*z[12]*z[14]*z[31]-z[48]*z[13]*
  z[22]*(z[11]*z[149]-z[12]*z[28])/(pow(z[29],0.5)*pow(z[30],2))-z[48]*z[11]*
  z[13]*z[22]*z[149]*pow(z[28],2)*(2+z[30]/pow(z[29],0.5))/(z[29]*pow(z[30],3)))-
  rb*z[13]*z[21]*(z[12]*(z[31]+z[16]*z[21]*z[28]/(pow(z[29],0.5)*pow(z[30],2))-
  z[49]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2))-z[11]*(z[151]+z[16]*
  z[21]*z[149]/(pow(z[29],0.5)*pow(z[30],2))-z[49]*z[28]*z[149]*(3*z[29]+pow(
  z[28],2))/(pow(z[29],1.5)*pow(z[30],2))-z[149]*pow(z[28],2)*(2*z[49]*z[28]-
  z[16]*z[21]*(2+z[30]/pow(z[29],0.5)))/(z[29]*pow(z[30],3)))))*q2p-2*(z[11]*
  z[14]*(l+z[18]-z[35])+z[48]*z[11]*z[12]*z[13]*(z[12]*z[28]/pow(z[29],0.5)-
  z[15]*(z[30]+pow(z[28],2)/pow(z[29],0.5)))/pow(z[30],2)-z[11]*z[13]*(z[17]+
  z[33])-z[22]*(rb*z[11]*z[14]*z[31]-ra*z[14]-z[48]*z[11]*z[13]*z[22]*z[28]/(
  pow(z[29],0.5)*pow(z[30],2)))-z[13]*z[21]*(ra-rb*z[11]*(z[31]+z[16]*z[21]*
  z[28]/(pow(z[29],0.5)*pow(z[30],2))-z[49]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/
  pow(z[30],2))))*(z[11]*z[153]+z[12]*z[13]*z[154]+z[12]*z[14]*z[152]+rb*
  z[22]*(z[11]*z[13]*z[31]+z[12]*z[13]*z[151]-z[22]*z[149]*pow(z[28],2)*(2+
  z[30]/pow(z[29],0.5))*(z[15]*z[11]-z[16]*z[12]*z[14])/(z[29]*pow(z[30],3))-(
  z[22]*z[149]*(z[15]*z[11]-z[16]*z[12]*z[14])-z[22]*z[28]*(z[15]*z[12]+z[16]*
  z[11]*z[14])-2*z[12]*z[13]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14]))/(pow(
  z[29],0.5)*pow(z[30],2)))-z[12]*z[34]-z[11]*z[14]*(z[17]+z[33])-rb*z[31]*
  pow(z[12],2)*pow(z[13],2)-z[11]*z[13]*(l+z[18]-z[35])-rb*z[12]*z[14]*(z[12]*
  z[14]*z[31]-z[49]*z[12]*z[14]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],
  2)-2*z[21]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],
  2)))-rb*z[11]*(z[11]*z[31]+2*z[12]*z[28]*(z[15]*z[11]-1.5*z[16]*z[12]*z[14])/(
  pow(z[29],0.5)*pow(z[30],2))-z[15]*(z[30]+pow(z[28],2)/pow(z[29],0.5))*(
  z[15]*z[11]-3*z[16]*z[12]*z[14])/pow(z[30],2))-rb*z[12]*(z[11]*z[151]+
  z[172]*z[12]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2)-z[12]*z[31]-
  z[12]*(z[15]*z[12]*z[28]-z[149]*(z[15]*z[11]-z[16]*z[12]*z[14]))/(pow(z[29],
  0.5)*pow(z[30],2))-z[15]*z[28]*z[149]*(3*z[29]+pow(z[28],2))*(z[15]*z[11]-
  z[16]*z[12]*z[14])/(pow(z[29],1.5)*pow(z[30],2))-z[149]*pow(z[28],2)*(z[15]*
  z[11]-z[16]*z[12]*z[14])*(2*z[15]*z[28]-z[12]*(2+z[30]/pow(z[29],0.5)))/(
  z[29]*pow(z[30],3)))-rb*z[21]*(z[16]*(z[15]*z[12]+z[16]*z[11]*z[14])*(z[30]+
  pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2)-z[11]*z[14]*z[31]-z[12]*z[14]*
  z[151]-z[16]*z[28]*z[149]*(3*z[29]+pow(z[28],2))*(z[15]*z[11]-z[16]*z[12]*
  z[14])/(pow(z[29],1.5)*pow(z[30],2))-z[21]*(z[28]*(z[15]*z[12]+z[16]*z[11]*
  z[14])-z[149]*(z[15]*z[11]-z[16]*z[12]*z[14]))/(pow(z[29],0.5)*pow(z[30],2))-
  z[149]*pow(z[28],2)*(z[15]*z[11]-z[16]*z[12]*z[14])*(2*z[16]*z[28]-z[21]*(2+
  z[30]/pow(z[29],0.5)))/(z[29]*pow(z[30],3))))*q2p)/pow((z[11]*z[14]*(l+
  z[18]-z[35])+z[48]*z[11]*z[12]*z[13]*(z[12]*z[28]/pow(z[29],0.5)-z[15]*(
  z[30]+pow(z[28],2)/pow(z[29],0.5)))/pow(z[30],2)-z[11]*z[13]*(z[17]+z[33])-
  z[22]*(rb*z[11]*z[14]*z[31]-ra*z[14]-z[48]*z[11]*z[13]*z[22]*z[28]/(pow(
  z[29],0.5)*pow(z[30],2)))-z[13]*z[21]*(ra-rb*z[11]*(z[31]+z[16]*z[21]*z[28]/(
  pow(z[29],0.5)*pow(z[30],2))-z[49]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(
  z[30],2)))),2);
  z[176] = (z[170]*(z[11]*z[14]*(l+z[18]-z[35])+z[48]*z[11]*z[12]*z[13]*(
  z[12]*z[28]/pow(z[29],0.5)-z[15]*(z[30]+pow(z[28],2)/pow(z[29],0.5)))/pow(
  z[30],2)-z[11]*z[13]*(z[17]+z[33])-z[22]*(rb*z[11]*z[14]*z[31]-ra*z[14]-
  z[48]*z[11]*z[13]*z[22]*z[28]/(pow(z[29],0.5)*pow(z[30],2)))-z[13]*z[21]*(
  ra-rb*z[11]*(z[31]+z[16]*z[21]*z[28]/(pow(z[29],0.5)*pow(z[30],2))-z[49]*(
  z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2))))*(z[11]*z[34]+rb*z[22]*(
  z[12]*z[13]*z[31]-z[22]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(z[29],
  0.5)*pow(z[30],2)))-z[12]*z[14]*(z[17]+z[33])-z[12]*z[13]*(l+z[18]-z[35])-
  rb*z[12]*(z[11]*z[31]+z[12]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(
  z[29],0.5)*pow(z[30],2))-z[15]*(z[30]+pow(z[28],2)/pow(z[29],0.5))*(z[15]*
  z[11]-z[16]*z[12]*z[14])/pow(z[30],2))-rb*z[21]*(z[21]*z[28]*(z[15]*z[11]-
  z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2))-z[12]*z[14]*z[31]-z[16]*(
  z[30]+pow(z[28],2)/pow(z[29],0.5))*(z[15]*z[11]-z[16]*z[12]*z[14])/pow(
  z[30],2)))+(z[11]*z[34]+rb*z[22]*(z[12]*z[13]*z[31]-z[22]*z[28]*(z[15]*
  z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2)))-z[12]*z[14]*(z[17]+
  z[33])-z[12]*z[13]*(l+z[18]-z[35])-rb*z[12]*(z[11]*z[31]+z[12]*z[28]*(z[15]*
  z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2))-z[15]*(z[30]+pow(
  z[28],2)/pow(z[29],0.5))*(z[15]*z[11]-z[16]*z[12]*z[14])/pow(z[30],2))-rb*
  z[21]*(z[21]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(
  z[30],2))-z[12]*z[14]*z[31]-z[16]*(z[30]+pow(z[28],2)/pow(z[29],0.5))*(
  z[15]*z[11]-z[16]*z[12]*z[14])/pow(z[30],2)))*(z[11]*z[13]*(z[161]+2*ra*
  z[13])+z[48]*z[11]*z[12]*z[14]*(z[12]*z[28]/pow(z[29],0.5)-z[15]*(z[30]+
  pow(z[28],2)/pow(z[29],0.5)))/pow(z[30],2)-z[11]*z[14]*z[163]-z[11]*z[14]*(
  z[17]+z[33])-z[11]*z[13]*(l+z[18]-z[35])-rb*pow(z[11],2)*pow(z[13],2)*(
  z[31]-z[49]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2))-z[11]*z[14]*(
  rb*z[11]*z[14]*z[31]-2*ra*z[14]-2*z[48]*z[11]*z[13]*z[22]*z[28]/(pow(z[29],
  0.5)*pow(z[30],2)))-z[48]*z[11]*z[12]*z[13]*z[159]*(2*z[12]*z[28]/pow(z[29],
  0.5)-z[15]*(z[30]+2*pow(z[28],2)/pow(z[29],0.5)))/(pow(z[29],0.5)*pow(z[30],
  3))-z[14]*z[21]*(ra-rb*z[11]*(z[31]+z[16]*z[21]*z[28]/(pow(z[29],0.5)*pow(
  z[30],2))-z[49]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2)))-z[48]*
  z[11]*z[12]*z[13]*(z[12]*z[28]*z[159]+z[16]*z[11]*z[12]*z[13]*z[29]-z[15]*
  z[28]*(z[28]*z[159]+2*z[16]*z[11]*z[13]*z[29]))/(pow(z[29],1.5)*pow(z[30],2))-
  z[22]*(ra*z[13]+z[48]*z[11]*z[13]*z[22]*z[28]*z[159]*(2+z[30]/pow(z[29],0.5))/(
  z[29]*pow(z[30],3))-rb*z[11]*z[13]*z[31]-z[11]*(rb*z[14]*z[159]+z[48]*z[14]*
  z[22]*z[28]-z[174]*z[11]*z[22]*pow(z[13],2))/(pow(z[29],0.5)*pow(z[30],2)))-
  rb*z[11]*z[13]*z[21]*((z[159]+z[49]*z[11]*z[13]*z[21]+2*z[16]*z[11]*z[13]*
  z[28])/(pow(z[29],0.5)*pow(z[30],2))-z[49]*(z[29]*z[159]+z[159]*pow(z[28],2)+
  2*z[16]*z[11]*z[13]*z[28]*z[29])/(pow(z[29],1.5)*pow(z[30],2))-z[28]*z[159]*(
  2*z[49]*z[28]-z[16]*z[21]*(2+z[30]/pow(z[29],0.5)))/(z[29]*pow(z[30],3))))*
  q2p+(z[11]*z[14]*(l+z[18]-z[35])+z[48]*z[11]*z[12]*z[13]*(z[12]*z[28]/pow(
  z[29],0.5)-z[15]*(z[30]+pow(z[28],2)/pow(z[29],0.5)))/pow(z[30],2)-z[11]*
  z[13]*(z[17]+z[33])-z[22]*(rb*z[11]*z[14]*z[31]-ra*z[14]-z[48]*z[11]*z[13]*
  z[22]*z[28]/(pow(z[29],0.5)*pow(z[30],2)))-z[13]*z[21]*(ra-rb*z[11]*(z[31]+
  z[16]*z[21]*z[28]/(pow(z[29],0.5)*pow(z[30],2))-z[49]*(z[30]+pow(z[28],2)/
  pow(z[29],0.5))/pow(z[30],2))))*(z[11]*z[162]+z[12]*z[14]*(l+z[18]-z[35])+2*
  rb*z[11]*z[14]*z[22]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*
  pow(z[30],2))-z[12]*z[13]*z[163]-z[12]*z[14]*z[161]-z[12]*z[13]*(z[17]+
  z[33])-rb*z[11]*z[13]*(z[15]*z[11]-z[16]*z[12]*z[14])*(2*z[21]*z[28]/(pow(
  z[29],0.5)*pow(z[30],2))-z[16]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(
  z[30],2))-rb*z[22]*(z[12]*z[14]*z[31]+z[22]*z[28]*z[159]*(2+z[30]/pow(z[29],
  0.5))*(z[15]*z[11]-z[16]*z[12]*z[14])/(z[29]*pow(z[30],3))-z[13]*(z[12]*
  z[159]+z[16]*z[12]*z[22]*z[28]-z[16]*z[11]*z[22]*(z[15]*z[11]-z[16]*z[12]*
  z[14]))/(pow(z[29],0.5)*pow(z[30],2)))-rb*z[12]*(z[175]*z[12]*z[13]*(z[30]+
  pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2)-z[28]*z[159]*(z[15]*z[11]-z[16]*
  z[12]*z[14])*(2*z[15]*z[28]-z[12]*(2+z[30]/pow(z[29],0.5)))/(z[29]*pow(
  z[30],3))-z[15]*(z[15]*z[11]-z[16]*z[12]*z[14])*(z[29]*z[159]+z[159]*pow(
  z[28],2)+2*z[16]*z[11]*z[13]*z[28]*z[29])/(pow(z[29],1.5)*pow(z[30],2))-(
  z[16]*z[13]*z[28]*pow(z[12],2)-z[11]*z[159]-z[16]*z[11]*z[12]*z[13]*(z[15]*
  z[11]-z[16]*z[12]*z[14]))/(pow(z[29],0.5)*pow(z[30],2)))-rb*z[21]*(z[49]*
  z[12]*z[13]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2)-z[12]*z[13]*
  z[31]-z[28]*z[159]*(z[15]*z[11]-z[16]*z[12]*z[14])*(2*z[16]*z[28]-z[21]*(2+
  z[30]/pow(z[29],0.5)))/(z[29]*pow(z[30],3))-z[16]*(z[15]*z[11]-z[16]*z[12]*
  z[14])*(z[29]*z[159]+z[159]*pow(z[28],2)+2*z[16]*z[11]*z[13]*z[28]*z[29])/(
  pow(z[29],1.5)*pow(z[30],2))-(z[12]*z[14]*z[159]+z[16]*z[12]*z[13]*z[21]*
  z[28]-z[16]*z[11]*z[13]*z[21]*(z[15]*z[11]-z[16]*z[12]*z[14]))/(pow(z[29],
  0.5)*pow(z[30],2))))*q2p)/pow((z[11]*z[14]*(l+z[18]-z[35])+z[48]*z[11]*
  z[12]*z[13]*(z[12]*z[28]/pow(z[29],0.5)-z[15]*(z[30]+pow(z[28],2)/pow(z[29],
  0.5)))/pow(z[30],2)-z[11]*z[13]*(z[17]+z[33])-z[22]*(rb*z[11]*z[14]*z[31]-
  ra*z[14]-z[48]*z[11]*z[13]*z[22]*z[28]/(pow(z[29],0.5)*pow(z[30],2)))-z[13]*
  z[21]*(ra-rb*z[11]*(z[31]+z[16]*z[21]*z[28]/(pow(z[29],0.5)*pow(z[30],2))-
  z[49]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2)))),2);
  z[177] = z[171]*(z[11]*z[34]+rb*z[22]*(z[12]*z[13]*z[31]-z[22]*z[28]*(z[15]*
  z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2)))-z[12]*z[14]*(z[17]+
  z[33])-z[12]*z[13]*(l+z[18]-z[35])-rb*z[12]*(z[11]*z[31]+z[12]*z[28]*(z[15]*
  z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(z[30],2))-z[15]*(z[30]+pow(
  z[28],2)/pow(z[29],0.5))*(z[15]*z[11]-z[16]*z[12]*z[14])/pow(z[30],2))-rb*
  z[21]*(z[21]*z[28]*(z[15]*z[11]-z[16]*z[12]*z[14])/(pow(z[29],0.5)*pow(
  z[30],2))-z[12]*z[14]*z[31]-z[16]*(z[30]+pow(z[28],2)/pow(z[29],0.5))*(
  z[15]*z[11]-z[16]*z[12]*z[14])/pow(z[30],2)))/(z[11]*z[14]*(l+z[18]-z[35])+
  z[48]*z[11]*z[12]*z[13]*(z[12]*z[28]/pow(z[29],0.5)-z[15]*(z[30]+pow(z[28],
  2)/pow(z[29],0.5)))/pow(z[30],2)-z[11]*z[13]*(z[17]+z[33])-z[22]*(rb*z[11]*
  z[14]*z[31]-ra*z[14]-z[48]*z[11]*z[13]*z[22]*z[28]/(pow(z[29],0.5)*pow(
  z[30],2)))-z[13]*z[21]*(ra-rb*z[11]*(z[31]+z[16]*z[21]*z[28]/(pow(z[29],0.5)*
  pow(z[30],2))-z[49]*(z[30]+pow(z[28],2)/pow(z[29],0.5))/pow(z[30],2))));
  z[178] = z[9]*z[20] - z[10]*z[14];
  z[179] = -z[9]*z[19] - z[10]*z[13];
  z[180] = (z[17]*z[178]+z[18]*z[179])*q3p;
  z[181] = z[10]*z[11]*(z[13]*z[17]-z[14]*z[18])*q3p - 0.5*(z[17]*z[55]+z[18]*
  z[51])*z[173];
  z[182] = z[9]*z[13] - z[10]*z[12]*z[14];
  z[183] = -z[9]*z[14] - z[10]*z[12]*z[13];
  z[184] = (z[17]*z[182]+z[18]*z[183]+ra*z[13]*z[55]-ra*z[14]*z[51])*q3p + (
  z[17]*z[55]+z[18]*z[51])*z[176];
  z[185] = z[177]*(z[17]*z[55]+z[18]*z[51]);
  z[186] = -z[9]*z[11]*(z[13]*z[17]-z[14]*z[18])*q3p - 0.5*(z[17]*z[56]+z[18]*
  z[52])*z[173];
  z[187] = z[10]*z[13] + z[9]*z[12]*z[14];
  z[188] = z[9]*z[12]*z[13] - z[10]*z[14];
  z[189] = (z[17]*z[187]+z[18]*z[188]+ra*z[13]*z[56]-ra*z[14]*z[52])*q3p + (
  z[17]*z[56]+z[18]*z[52])*z[176];
  z[190] = z[177]*(z[17]*z[56]+z[18]*z[52]);
  z[191] = (2*z[39]*z[153]-z[34]*z[155]/pow(z[38],0.5))/pow(z[39],2);
  z[192] = -z[15]*z[12] - z[16]*z[11]*z[14];
  z[193] = z[26]*z[149] + z[28]*z[192];
  z[194] = (z[29]*z[193]+z[28]*z[64]*z[149])/pow(z[29],1.5);
  z[195] = (z[30]*(z[28]*z[194]+z[30]*z[192]+z[66]*z[149])+z[28]*z[149]*(
  z[26]*z[30]+2*z[28]*z[66])/pow(z[29],0.5))/pow(z[30],3);
  z[196] = (z[30]*z[194]+2*z[28]*z[66]*z[149]/pow(z[29],0.5))/pow(z[30],3);
  z[197] = rb*(z[15]*z[195]+z[12]*z[31]-z[11]*z[70]-z[11]*z[151]-z[12]*z[196]);
  z[198] = rb*(z[21]*z[196]-z[16]*z[195]-z[19]*z[151]-z[11]*z[14]*z[31]-z[12]*
  z[14]*z[70]);
  z[199] = rb*(z[22]*z[196]-z[20]*z[151]-z[11]*z[13]*z[31]-z[12]*z[13]*z[70]);
  z[200] = 2*z[34]*z[197] + 2*z[37]*z[199] + 2*z[75]*z[153] - 2*z[36]*z[198] - 
  2*z[72]*z[152] - 2*z[77]*z[154];
  z[201] = (2*z[38]*z[200]-z[80]*z[155])/pow(z[38],1.5);
  z[202] = (2*z[155]*(z[37]*z[82]+z[39]*z[77])/pow(z[38],0.5)+z[39]*(4*z[39]*
  z[199]-2*z[82]*z[154]-z[37]*z[201]))/pow(z[39],3);
  z[203] = z[63]*z[149] - z[16]*z[12]*z[13]*z[28];
  z[204] = (z[29]*z[203]+z[28]*z[65]*z[149])/pow(z[29],1.5);
  z[205] = (z[28]*z[149]*(z[30]*z[63]+2*z[28]*z[67])/pow(z[29],0.5)+z[30]*(
  z[28]*z[204]+z[67]*z[149]-z[16]*z[12]*z[13]*z[30]))/pow(z[30],3);
  z[206] = (z[30]*z[204]+2*z[28]*z[67]*z[149]/pow(z[29],0.5))/pow(z[30],3);
  z[207] = rb*(z[15]*z[205]-z[11]*z[71]-z[12]*z[206]);
  z[208] = rb*(z[21]*z[206]+z[22]*z[151]-z[16]*z[205]-z[12]*z[13]*z[31]-z[12]*
  z[14]*z[71]);
  z[209] = rb*(z[21]*z[151]+z[12]*z[13]*z[71]-z[22]*z[206]-z[12]*z[14]*z[31]);
  z[210] = 2*z[34]*z[207] + 2*z[76]*z[153] + 2*z[79]*z[154] - 2*z[36]*z[208] - 
  2*z[37]*z[209] - 2*z[74]*z[152];
  z[211] = (2*z[38]*z[210]-z[81]*z[155])/pow(z[38],1.5);
  z[212] = (2*z[37]*z[83]*z[155]/pow(z[38],0.5)-z[39]*(z[37]*z[211]+2*z[83]*
  z[154]+4*z[39]*z[209]+2*z[79]*z[155]/pow(z[38],0.5)))/pow(z[39],3);
  z[213] = 0.25*z[94]*z[169] + 0.25*w*z[202]*q2p + 0.25*w*z[212]*q3p + 0.25*
  z[95]*z[173];
  z[214] = (2*z[36]*z[82]*z[155]/pow(z[38],0.5)+z[39]*(2*z[82]*z[152]-4*z[39]*
  z[198]-z[36]*z[201]-2*z[72]*z[155]/pow(z[38],0.5)))/pow(z[39],3);
  z[215] = (2*z[36]*z[83]*z[155]/pow(z[38],0.5)+z[39]*(2*z[83]*z[152]-4*z[39]*
  z[208]-z[36]*z[211]-2*z[74]*z[155]/pow(z[38],0.5)))/pow(z[39],3);
  z[216] = 0.25*z[86]*z[169] + 0.25*w*z[214]*q2p + 0.25*w*z[215]*q3p + 0.25*
  z[87]*z[173];
  z[217] = (2*z[34]*z[82]*z[155]/pow(z[38],0.5)+z[39]*(4*z[39]*z[197]-2*z[82]*
  z[153]-z[34]*z[201]-2*z[75]*z[155]/pow(z[38],0.5)))/pow(z[39],3);
  z[218] = (2*z[34]*z[83]*z[155]/pow(z[38],0.5)+z[39]*(4*z[39]*z[207]-2*z[83]*
  z[153]-z[34]*z[211]-2*z[76]*z[155]/pow(z[38],0.5)))/pow(z[39],3);
  z[219] = -0.25*z[90]*z[169] - 0.25*w*z[217]*q2p - 0.25*w*z[218]*q3p - 0.25*
  z[91]*z[173];
  z[220] = 0.5*z[17]*z[157] - 0.5*z[156]*(k+z[18]);
  z[221] = 0.25*z[17]*z[218] + 0.5*z[18]*z[191];
  z[222] = 0.25*z[113]*z[169] + pow(w,2)*z[40]*z[220] + 0.5*pow(w,2)*z[59]*
  z[191] + 0.5*pow(w,2)*z[42]*z[191]*(k+z[18]) + w*z[221]*q3p + 0.25*w*z[17]*
  z[217]*q2p - 0.5*pow(w,2)*z[60]*z[156] - 0.5*z[112]*z[173];
  z[223] = 0.25*z[218]*(k+z[18]) - 0.5*z[17]*z[191];
  z[224] = w*z[217]*(k+z[18]);
  z[225] = 0.25*z[105]*z[169] + 0.25*z[224]*q2p + w*z[223]*q3p - pow(w,2)*
  z[41]*z[220] - 0.5*pow(w,2)*z[60]*z[157] - 0.5*pow(w,2)*z[61]*z[191] - 0.5*
  pow(w,2)*z[17]*z[42]*z[191] - 0.5*z[104]*z[173];
  z[226] = 0.25*z[17]*z[212] + 0.5*z[17]*z[156] + 0.5*z[18]*z[157] + 0.25*
  z[215]*(k+z[18]);
  z[227] = 0.25*z[17]*z[202] + 0.25*z[214]*(k+z[18]);
  z[228] = 0.5*pow(w,2)*z[59]*z[157] + 0.5*pow(w,2)*z[61]*z[156] + 0.5*pow(w,
  2)*z[41]*z[191]*(k+z[18]) + w*z[226]*q3p + w*z[227]*q2p - 0.5*z[109]*z[169] - 
  0.5*pow(w,2)*z[17]*z[40]*z[191] - 0.5*z[108]*z[173];
  z[229] = 0.5*z[118]*(2*z[12]*z[13]*z[17]*z[42]+z[21]*z[191]*(k+z[18])-z[17]*
  z[22]*z[191]-2*z[12]*z[14]*z[42]*(k+z[18])-2*z[11]*(z[17]*z[41]+z[40]*(k+
  z[18]))-z[12]*(z[17]*z[157]-z[156]*(k+z[18]))) + Izz*z[41]*z[213] + 0.5*Izz*
  z[157]*z[98] + z[40]*(Ixx*z[216]+Ixy*z[219]) + 0.5*m*(z[17]*z[191]*z[116]+2*
  z[17]*z[42]*z[222]+z[191]*(k+z[18])*z[114]+2*z[42]*(k+z[18])*z[225]+(z[17]*
  z[157]-z[156]*(k+z[18]))*z[115]+2*(z[17]*z[41]+z[40]*(k+z[18]))*z[228]) - 
  z[42]*(Ixy*z[216]+Iyy*z[219]) - 0.5*z[156]*(Ixx*z[96]+Ixy*z[97]) - 0.5*
  z[191]*(Ixy*z[96]+Iyy*z[97]);
  z[230] = Ixx*z[40]*z[156] + z[191]*(Ixy*z[40]-Iyy*z[42]) - Ixy*z[42]*z[156] - 
  Izz*z[41]*z[157] - 0.5*m*z[17]*z[61]*z[191] - 0.5*m*z[42]*z[191]*pow(z[17],
  2) - 0.5*m*z[59]*z[191]*(k+z[18]) - 0.5*m*z[42]*z[191]*pow((k+z[18]),2) - m*
  z[220]*(z[17]*z[41]+z[40]*(k+z[18])) - 0.5*m*z[60]*(z[17]*z[157]-z[156]*(k+
  z[18]));
  z[231] = (z[117]*z[229]-z[230]*z[119])/pow(z[117],2);
  z[232] = (2*z[39]*z[162]-z[34]*z[164]/pow(z[38],0.5))/pow(z[39],2);
  z[233] = z[16]*z[13]*(z[11]*z[26]-z[12]*z[28]);
  z[234] = (z[29]*z[233]+z[64]*z[159])/pow(z[29],1.5);
  z[235] = (z[159]*(z[26]*z[30]+2*z[28]*z[66])/pow(z[29],0.5)+z[30]*(z[28]*
  z[234]+z[16]*z[11]*z[13]*z[66]-z[16]*z[12]*z[13]*z[30]))/pow(z[30],3);
  z[236] = (z[30]*z[234]+2*z[66]*z[159]/pow(z[29],0.5))/pow(z[30],3);
  z[237] = rb*(z[15]*z[235]-z[12]*z[236]-z[11]*z[159]/(pow(z[29],0.5)*pow(
  z[30],2)));
  z[238] = rb*(z[21]*z[236]+z[11]*z[13]*z[70]-z[16]*z[235]-z[12]*z[13]*z[31]-
  z[19]*z[159]/(pow(z[29],0.5)*pow(z[30],2)));
  z[239] = rb*(z[22]*z[236]+z[12]*z[14]*z[31]-z[11]*z[14]*z[70]-z[20]*z[159]/(
  pow(z[29],0.5)*pow(z[30],2)));
  z[240] = 2*z[34]*z[237] + 2*z[37]*z[239] + 2*z[75]*z[162] + 2*z[72]*(z[161]+
  ra*z[13]) + 2*z[77]*(z[163]-ra*z[14]) - 2*z[36]*z[238];
  z[241] = (2*z[38]*z[240]-z[80]*z[164])/pow(z[38],1.5);
  z[242] = (2*z[164]*(z[37]*z[82]+z[39]*z[77])/pow(z[38],0.5)-z[39]*(z[37]*
  z[241]-4*z[39]*z[239]-2*z[82]*(z[163]-ra*z[14])))/pow(z[39],3);
  z[243] = z[16]*z[11]*(z[13]*z[63]-z[14]*z[28]);
  z[244] = (z[29]*z[243]+z[65]*z[159])/pow(z[29],1.5);
  z[245] = (z[159]*(z[30]*z[63]+2*z[28]*z[67])/pow(z[29],0.5)+z[30]*(z[28]*
  z[244]+z[16]*z[11]*z[13]*z[67]-z[16]*z[11]*z[14]*z[30]))/pow(z[30],3);
  z[246] = (z[30]*z[244]+2*z[67]*z[159]/pow(z[29],0.5))/pow(z[30],3);
  z[247] = rb*(z[15]*z[245]-z[12]*z[246]);
  z[248] = rb*(z[16]*z[245]+z[11]*z[14]*z[31]-z[21]*z[246]-z[11]*z[13]*z[71]-
  z[22]*z[159]/(pow(z[29],0.5)*pow(z[30],2)));
  z[249] = rb*(z[22]*z[246]-z[11]*z[13]*z[31]-z[11]*z[14]*z[71]-z[21]*z[159]/(
  pow(z[29],0.5)*pow(z[30],2)));
  z[250] = 2*z[34]*z[247] + 2*z[76]*z[162] + 2*z[37]*(z[249]+ra*z[13]) + 2*
  z[74]*(z[161]+ra*z[13]) + 2*z[36]*(z[248]-ra*z[14]) - 2*z[79]*(z[163]-ra*
  z[14]);
  z[251] = (2*z[38]*z[250]-z[81]*z[164])/pow(z[38],1.5);
  z[252] = (2*z[164]*(z[37]*z[83]-z[39]*z[79])/pow(z[38],0.5)-z[39]*(z[37]*
  z[251]-4*z[39]*(z[249]+ra*z[13])-2*z[83]*(z[163]-ra*z[14])))/pow(z[39],3);
  z[253] = 0.25*w*z[242]*q2p + 0.25*w*z[252]*q3p - 0.5*z[94]*z[170] - 0.5*
  z[95]*z[176];
  z[254] = (2*z[164]*(z[36]*z[82]-z[39]*z[72])/pow(z[38],0.5)-z[39]*(z[36]*
  z[241]+4*z[39]*z[238]+2*z[82]*(z[161]+ra*z[13])))/pow(z[39],3);
  z[255] = (2*z[164]*(z[36]*z[83]-z[39]*z[74])/pow(z[38],0.5)-z[39]*(z[36]*
  z[251]+2*z[83]*(z[161]+ra*z[13])-4*z[39]*(z[248]-ra*z[14])))/pow(z[39],3);
  z[256] = 0.25*w*z[254]*q2p + 0.25*w*z[255]*q3p - 0.5*z[86]*z[170] - 0.5*
  z[87]*z[176];
  z[257] = (2*z[34]*z[82]*z[164]/pow(z[38],0.5)+z[39]*(4*z[39]*z[237]-2*z[82]*
  z[162]-z[34]*z[241]-2*z[75]*z[164]/pow(z[38],0.5)))/pow(z[39],3);
  z[258] = (2*z[34]*z[83]*z[164]/pow(z[38],0.5)+z[39]*(4*z[39]*z[247]-2*z[83]*
  z[162]-z[34]*z[251]-2*z[76]*z[164]/pow(z[38],0.5)))/pow(z[39],3);
  z[259] = 0.5*z[90]*z[170] + 0.5*z[91]*z[176] - 0.25*w*z[257]*q2p - 0.25*w*
  z[258]*q3p;
  z[260] = ra*z[13]*z[41] - 0.5*z[17]*z[166] - ra*z[14]*z[40] - 0.5*z[165]*(k+
  z[18]);
  z[261] = 0.5*z[232]*(k+z[18]) - ra*z[14]*z[42];
  z[262] = 0.25*z[17]*z[258] + 0.5*z[18]*z[232] - ra*z[14]*z[42] - 0.5*ra*
  z[13]*z[89];
  z[263] = ra*z[13]*z[88] - 0.5*z[17]*z[257];
  z[264] = pow(w,2)*z[40]*z[260] + pow(w,2)*z[42]*z[261] + 0.5*pow(w,2)*z[59]*
  z[232] + w*z[262]*q3p + z[112]*z[176] - 0.5*z[113]*z[170] - 0.5*pow(w,2)*
  z[60]*z[165] - 0.5*w*z[263]*q2p;
  z[265] = 0.5*ra*z[14]*z[89] + 0.25*z[258]*(k+z[18]) - 0.5*z[17]*z[232] - ra*
  z[13]*z[42];
  z[266] = 0.5*z[17]*z[232] + ra*z[13]*z[42];
  z[267] = -ra*z[14]*z[88] - 0.5*z[257]*(k+z[18]);
  z[268] = 0.5*pow(w,2)*z[60]*z[166] + w*z[265]*q3p + z[104]*z[176] - 0.5*
  z[105]*z[170] - pow(w,2)*z[41]*z[260] - pow(w,2)*z[42]*z[266] - 0.5*pow(w,2)*
  z[61]*z[232] - 0.5*w*z[267]*q2p;
  z[269] = 0.25*z[17]*z[252] + 0.5*z[17]*z[165] + 0.5*ra*z[14]*z[85] + 0.25*
  z[255]*(k+z[18]) - 0.5*z[18]*z[166] - ra*z[13]*z[40] - ra*z[14]*z[41] - 0.5*
  ra*z[13]*z[93];
  z[270] = 0.25*z[17]*z[242] + 0.5*ra*z[14]*z[84] + 0.25*z[254]*(k+z[18]) - 
  0.5*ra*z[13]*z[92];
  z[271] = z[109]*z[170] + pow(w,2)*z[41]*z[261] + 0.5*pow(w,2)*z[61]*z[165] + 
  w*z[269]*q3p + w*z[270]*q2p + z[108]*z[176] - pow(w,2)*z[40]*z[266] - 0.5*
  pow(w,2)*z[59]*z[166];
  z[272] = 0.5*z[118]*(2*z[11]*z[14]*z[17]*z[42]+z[21]*z[232]*(k+z[18])+2*
  z[11]*z[13]*z[42]*(k+z[18])-z[17]*z[22]*z[232]-2*ra*z[13]*z[22]*z[42]-2*ra*
  z[14]*z[21]*z[42]-z[12]*(2*ra*z[13]*z[41]-z[17]*z[166]-2*ra*z[14]*z[40]-
  z[165]*(k+z[18]))) + Izz*z[41]*z[253] + z[40]*(Ixx*z[256]+Ixy*z[259]) - 0.5*
  Izz*z[166]*z[98] - z[42]*(Ixy*z[256]+Iyy*z[259]) - 0.5*z[165]*(Ixx*z[96]+
  Ixy*z[97]) - 0.5*z[232]*(Ixy*z[96]+Iyy*z[97]) - 0.5*m*(2*ra*z[14]*z[42]*
  z[114]-2*z[17]*z[42]*z[264]-z[17]*z[232]*z[116]-2*ra*z[13]*z[42]*z[116]-2*
  z[42]*(k+z[18])*z[268]-z[232]*(k+z[18])*z[114]-2*(z[17]*z[41]+z[40]*(k+
  z[18]))*z[271]-(2*ra*z[13]*z[41]-z[17]*z[166]-2*ra*z[14]*z[40]-z[165]*(k+
  z[18]))*z[115]);
  z[274] = Ixx*z[40]*z[165] + Izz*z[41]*z[166] + z[273]*z[14]*z[42]*z[59] + 
  z[232]*(Ixy*z[40]-Iyy*z[42]) - Ixy*z[42]*z[165] - m*z[17]*z[42]*z[266] - 
  z[273]*z[13]*z[42]*z[61] - 0.5*m*z[17]*z[61]*z[232] - m*z[42]*z[261]*(k+
  z[18]) - 0.5*m*z[59]*z[232]*(k+z[18]) - m*z[260]*(z[17]*z[41]+z[40]*(k+
  z[18])) - 0.5*m*z[60]*(2*ra*z[13]*z[41]-z[17]*z[166]-2*ra*z[14]*z[40]-
  z[165]*(k+z[18]));
  z[275] = (z[117]*z[272]-z[274]*z[119])/pow(z[117],2);
  z[276] = -0.5*z[94]*z[171] - 0.5*z[95]*z[177] - 0.5*z[92]*q2p - 0.5*z[93]*
  q3p;
  z[277] = -0.5*z[86]*z[171] - 0.5*z[87]*z[177] - 0.5*z[84]*q2p - 0.5*z[85]*
  q3p;
  z[278] = 0.5*z[90]*z[171] + 0.5*z[91]*z[177] + 0.5*z[88]*q2p + 0.5*z[89]*
  q3p;
  z[279] = z[112]*z[177] + 2*w*z[40]*z[60] + 2*w*z[42]*z[59] + z[110]*q3p - 
  0.5*z[113]*z[171] - 0.5*z[111]*q2p;
  z[280] = z[104]*z[177] + z[102]*q3p - 0.5*z[105]*z[171] - 2*w*z[41]*z[60] - 
  2*w*z[42]*z[61] - 0.5*z[103]*q2p;
  z[281] = z[108]*z[177] + z[109]*z[171] + 2*w*z[41]*z[59] + z[106]*q3p + 
  z[107]*q2p - 2*w*z[40]*z[61];
  z[282] = Izz*z[41]*z[276] + z[40]*(Ixx*z[277]+Ixy*z[278]) + m*(z[17]*z[42]*
  z[279]+z[42]*(k+z[18])*z[280]+(z[17]*z[41]+z[40]*(k+z[18]))*z[281]) - z[42]*(
  Ixy*z[277]+Iyy*z[278]);

  no_cb[0] = q4 + z[34]*z[53] + z[51]*(z[17]+z[33]) - z[55]*(l+z[18]-z[35]);
  no_cb[1] = q5 + z[52]*(z[17]+z[33]) - z[34]*z[54] - z[56]*(l+z[18]-z[35]);
  no_cb[2] = -z[12]*z[34] - z[21]*(z[17]+z[33]) - z[22]*(l+z[18]-z[35]);
  no_so[0] = q4 + z[17]*z[51] - z[55]*(k+z[18]);
  no_so[1] = q5 + z[17]*z[52] - z[56]*(k+z[18]);
  no_so[2] = -z[17]*z[21] - z[22]*(k+z[18]);
  a_so[0] = z[40]*(z[59]*wp+z[114]) + z[41]*(z[61]*wp+z[116]) - z[42]*(z[60]*
  wp+z[115]);
  a_so[1] = z[12]*z[41]*(z[59]*wp+z[114]) + z[11]*z[13]*z[42]*(z[59]*wp+
  z[114]) + z[11]*z[14]*z[42]*(z[61]*wp+z[116]) + (z[21]*z[41]+z[22]*z[40])*(
  z[60]*wp+z[115]) - z[12]*z[40]*(z[61]*wp+z[116]);
  a_so[2] = z[12]*(z[60]*wp+z[115]) + z[22]*(z[61]*wp+z[116]) - z[21]*(z[59]*
  wp+z[114]);
  H[0] = w*(Iyy*pow(z[42],2)+Izz*pow(z[41],2)+z[40]*(Ixx*z[40]-2*Ixy*z[42]));
  H[1] = -w*(Izz*z[12]*z[40]*z[41]-Izz*z[11]*z[14]*z[41]*z[42]-z[12]*z[41]*(
  Ixx*z[40]-Ixy*z[42])-z[11]*z[13]*z[42]*(Ixx*z[40]-Ixy*z[42])-(z[21]*z[41]+
  z[22]*z[40])*(Ixy*z[40]-Iyy*z[42]));
  H[2] = w*(Izz*z[22]*z[41]+z[12]*(Ixy*z[40]-Iyy*z[42])-z[21]*(Ixx*z[40]-Ixy*
  z[42]));
  p[0] = m*w*(z[40]*z[59]+z[41]*z[61]-z[42]*z[60]);
  p[1] = -m*w*(z[12]*z[40]*z[61]-z[12]*z[41]*z[59]-z[11]*z[13]*z[42]*z[59]-
  z[11]*z[14]*z[42]*z[61]-z[60]*(z[21]*z[41]+z[22]*z[40]));
  p[2] = -m*w*(z[21]*z[59]-z[12]*z[60]-z[22]*z[61]);
  df[0] = 0;
  df[1] = 0.5*z[158];
  df[2] = -0.5*z[167];
  df[3] = 0;
  df[4] = 0;
  df[5] = z[168];
  df[6] = 0;
  df[7] = -0.5*z[169];
  df[8] = z[170];
  df[9] = 0;
  df[10] = 0;
  df[11] = z[171];
  df[12] = 0;
  df[13] = -0.5*z[173];
  df[14] = z[176];
  df[15] = 0;
  df[16] = 0;
  df[17] = z[177];
  df[18] = -z[180];
  df[19] = -z[181];
  df[20] = -z[184];
  df[21] = 0;
  df[22] = 0;
  df[23] = -z[185];
  df[24] = -z[57];
  df[25] = -z[186];
  df[26] = -z[189];
  df[27] = 0;
  df[28] = 0;
  df[29] = -z[190];
  df[30] = 0;
  df[31] = z[231];
  df[32] = z[275];
  df[33] = 0;
  df[34] = 0;
  df[35] = z[282]/z[117];
  T_da[0] = z[128];
  T_da[1] = z[131];
  T_da[2] = z[134];
  T_da[3] = 0;
  T_da[4] = z[129];
  T_da[5] = z[132];
  T_da[6] = z[135];
  T_da[7] = 0;
  T_da[8] = z[130];
  T_da[9] = z[133];
  T_da[10] = z[136];
  T_da[11] = 0;
  T_da[12] = z[17]*z[128] - z[1]*(ctx-q4) - z[2]*(cty-q5) - z[18]*z[130];
  T_da[13] = ctz*z[6] + z[5]*(cty-q5) + z[17]*z[131] - z[4]*(ctx-q4) - z[18]*
  z[133];
  T_da[14] = ctz*z[3] + z[7]*(ctx-q4) + z[17]*z[134] - d - z[8]*(cty-q5) - 
  z[18]*z[136];
  T_da[15] = 1;
  T_db[0] = z[137];
  T_db[1] = z[139];
  T_db[2] = z[141];
  T_db[3] = 0;
  T_db[4] = z[138];
  T_db[5] = z[140];
  T_db[6] = z[142];
  T_db[7] = 0;
  T_db[8] = z[130];
  T_db[9] = z[133];
  T_db[10] = z[136];
  T_db[11] = 0;
  T_db[12] = z[17]*z[128] - z[1]*(ctx-q4) - z[2]*(cty-q5) - z[130]*(l+z[18]);
  T_db[13] = ctz*z[6] + z[5]*(cty-q5) + z[17]*z[131] - z[4]*(ctx-q4) - z[133]*(
  l+z[18]);
  T_db[14] = ctz*z[3] + z[7]*(ctx-q4) + z[17]*z[134] - d - z[8]*(cty-q5) - 
  z[136]*(l+z[18]);
  T_db[15] = 1;
  T_so[0] = z[128];
  T_so[1] = z[131];
  T_so[2] = z[134];
  T_so[3] = 0;
  T_so[4] = z[129];
  T_so[5] = z[132];
  T_so[6] = z[135];
  T_so[7] = 0;
  T_so[8] = z[130];
  T_so[9] = z[133];
  T_so[10] = z[136];
  T_so[11] = 0;
  T_so[12] = z[17]*z[128] - z[1]*(ctx-q4) - z[2]*(cty-q5) - z[130]*(k+z[18]);
  T_so[13] = ctz*z[6] + z[5]*(cty-q5) + z[17]*z[131] - z[4]*(ctx-q4) - z[133]*(
  k+z[18]);
  T_so[14] = ctz*z[3] + z[7]*(ctx-q4) + z[17]*z[134] - d - z[8]*(cty-q5) - 
  z[136]*(k+z[18]);
  T_so[15] = 1;
  T_ca[0] = z[143];
  T_ca[1] = z[145];
  T_ca[2] = z[147];
  T_ca[3] = 0;
  T_ca[4] = z[144];
  T_ca[5] = z[146];
  T_ca[6] = z[148];
  T_ca[7] = 0;
  T_ca[8] = 0;
  T_ca[9] = -z[6];
  T_ca[10] = -z[3];
  T_ca[11] = 0;
  T_ca[12] = -z[1]*(ctx-q4) - z[2]*(cty-q5);
  T_ca[13] = ctz*z[6] + z[5]*(cty-q5) - z[4]*(ctx-q4);
  T_ca[14] = ctz*z[3] + z[7]*(ctx-q4) - d - z[8]*(cty-q5);
  T_ca[15] = 1;
  T_cb[0] = z[11]*z[46]*z[143] + z[12]*z[47]*z[128] + z[129]*(z[21]*z[47]+
  z[22]*z[45]) - z[12]*z[45]*z[130];
  T_cb[1] = z[11]*z[46]*z[145] + z[12]*z[47]*z[131] + z[132]*(z[21]*z[47]+
  z[22]*z[45]) - z[12]*z[45]*z[133];
  T_cb[2] = z[11]*z[46]*z[147] + z[12]*z[47]*z[134] + z[135]*(z[21]*z[47]+
  z[22]*z[45]) - z[12]*z[45]*z[136];
  T_cb[3] = 0;
  T_cb[4] = z[11]*z[46]*z[144] - z[45]*z[128]*pow(z[12],2) - z[47]*z[130]*
  pow(z[12],2) - z[11]*z[143]*(z[21]*z[47]+z[22]*z[45]) - z[12]*z[129]*(z[21]*
  z[45]-z[22]*z[47]);
  T_cb[5] = z[11]*z[46]*z[146] - z[45]*z[131]*pow(z[12],2) - z[47]*z[133]*
  pow(z[12],2) - z[11]*z[145]*(z[21]*z[47]+z[22]*z[45]) - z[12]*z[132]*(z[21]*
  z[45]-z[22]*z[47]);
  T_cb[6] = z[11]*z[46]*z[148] - z[45]*z[134]*pow(z[12],2) - z[47]*z[136]*
  pow(z[12],2) - z[11]*z[147]*(z[21]*z[47]+z[22]*z[45]) - z[12]*z[135]*(z[21]*
  z[45]-z[22]*z[47]);
  T_cb[7] = 0;
  T_cb[8] = 0;
  T_cb[9] = -z[6];
  T_cb[10] = -z[3];
  T_cb[11] = 0;
  T_cb[12] = z[128]*(z[17]+z[33]) - z[1]*(ctx-q4) - z[2]*(cty-q5) - z[34]*
  z[129] - z[130]*(l+z[18]-z[35]);
  T_cb[13] = ctz*z[6] + z[5]*(cty-q5) + z[131]*(z[17]+z[33]) - z[4]*(ctx-q4) - 
  z[34]*z[132] - z[133]*(l+z[18]-z[35]);
  T_cb[14] = ctz*z[3] + z[7]*(ctx-q4) + z[134]*(z[17]+z[33]) - d - z[8]*(cty-
  q5) - z[34]*z[135] - z[136]*(l+z[18]-z[35]);
  T_cb[15] = 1;
  T_dagl[0] = z[128];
  T_dagl[1] = z[131];
  T_dagl[2] = z[134];
  T_dagl[3] = 0;
  T_dagl[4] = -z[130];
  T_dagl[5] = -z[133];
  T_dagl[6] = -z[136];
  T_dagl[7] = 0;
  T_dagl[8] = z[129];
  T_dagl[9] = z[132];
  T_dagl[10] = z[135];
  T_dagl[11] = 0;
  T_dagl[12] = z[17]*z[128] - z[1]*(ctx-q4) - z[2]*(cty-q5) - z[18]*z[130];
  T_dagl[13] = ctz*z[6] + z[5]*(cty-q5) + z[17]*z[131] - z[4]*(ctx-q4) - 
  z[18]*z[133];
  T_dagl[14] = ctz*z[3] + z[7]*(ctx-q4) + z[17]*z[134] - d - z[8]*(cty-q5) - 
  z[18]*z[136];
  T_dagl[15] = 1;
  T_dbgl[0] = z[137];
  T_dbgl[1] = z[139];
  T_dbgl[2] = z[141];
  T_dbgl[3] = 0;
  T_dbgl[4] = -z[130];
  T_dbgl[5] = -z[133];
  T_dbgl[6] = -z[136];
  T_dbgl[7] = 0;
  T_dbgl[8] = z[138];
  T_dbgl[9] = z[140];
  T_dbgl[10] = z[142];
  T_dbgl[11] = 0;
  T_dbgl[12] = z[17]*z[128] - z[1]*(ctx-q4) - z[2]*(cty-q5) - z[130]*(l+z[18]);
  T_dbgl[13] = ctz*z[6] + z[5]*(cty-q5) + z[17]*z[131] - z[4]*(ctx-q4) - 
  z[133]*(l+z[18]);
  T_dbgl[14] = ctz*z[3] + z[7]*(ctx-q4) + z[17]*z[134] - d - z[8]*(cty-q5) - 
  z[136]*(l+z[18]);
  T_dbgl[15] = 1;
  if (faz > 0.0)
    tensile[0] = true;
  else
    tensile[0] = false;
  if (fbz > 0.0)
    tensile[1] = true;
  else
    tensile[1] = false;
} // computeOutputs()

void SlottedDiscs::setState(const double state[6])
{
  q1 = state[0];
  q2 = state[1];
  q3 = state[2];
  q4 = state[3];
  q5 = state[4];
  w = state[5];
} // setState()

void SlottedDiscs::setParameters(DiscParams * p)
{
  m = p->m;
  ra = p->ra;
  rb = p->rb;
  k = p->k;
  l = p->l;
  g = p->g;
  alpha = p->alpha;
  Ixx = p->Ixx;
  Iyy = p->Iyy;
  Izz = p->Izz;
  Ixy = p->Ixy;

  evalConstants();
} // setParameters()

double SlottedDiscs::hc(void)
{
  return rb*pow((1-pow((cos(alpha)*sin(q2)+sin(alpha)*sin(q3)*cos(q2)),2)),0.5) - ra*cos(q2) - l*cos(q2)*cos(q3);
} // hc()

double SlottedDiscs::hc_deriv(void)
{
  return cos(q2)*(l*sin(q3)-rb*sin(alpha)*cos(q3)*(cos(alpha)*sin(q2)+sin(alpha)*sin(q3)*cos(q2))/pow((1-pow((cos(alpha)*sin(q2)+sin(alpha)*sin(q3)*cos(q2)),2)),0.5));
} // hc()
